<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WarMaster | Master</title>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --panel2:#0f1117;
      --line:#232736;
      --text:#e9ecf3;
      --muted:#a8b0c3;

      /* Brand base */
      --brand:#6d5efc;
      --brand2:#2dd4bf;

      /* Plan colors (official) */
      --free:#ffffff;   /* FREE blanco */
      --plus:#f5c542;   /* PLUS amarillo */
      --pro:#4ea8ff;    /* PRO azul */

      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#22c55e;

      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(109,94,252,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #06070a 70%);
      color:var(--text);
      min-height:100vh;
      padding:18px;
    }

    .wrap{width:min(1120px,100%); margin:0 auto}
    a{color:inherit}

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.3px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 0 0 6px rgba(109,94,252,.12);
    }
    .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .pill{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }

    /* Plan pill */
    .planPill{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      font-weight:900;
    }
    .planPill.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
    .planPill.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }
    .planPill.free{ color: var(--free); border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.03); }

    /* Card + optional plan glow */
    .card{
      background: rgba(18,20,27,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardGlowPlus{ box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(245,197,66,.18), 0 0 24px rgba(245,197,66,.10); }
    .cardGlowPro{  box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(78,168,255,.18), 0 0 24px rgba(78,168,255,.10); }

    .head{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .head h2{margin:0; font-size:16px}

    .body{padding:16px 18px}
    .muted{color:var(--muted)}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:900;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.06)}
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Plan buttons accents */
    .btnPlus{
      border-color: rgba(245,197,66,.45);
      background: rgba(245,197,66,.10);
      color: var(--plus);
    }
    .btnPro{
      border-color: rgba(78,168,255,.45);
      background: rgba(78,168,255,.10);
      color: var(--pro);
    }

    .btnPrimary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
      color: #fff;
    }
    .btnPrimary:hover{filter:brightness(1.06)}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .selectGrid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    @media (max-width: 520px){ .selectGrid{grid-template-columns:1fr} }

    .opt{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
      position:relative;
    }
    .opt:hover{background: rgba(255,255,255,.05)}
    .opt:active{transform: translateY(1px)}
    .opt b{display:block; margin-bottom:6px}
    .opt small{color:var(--muted)}
    .opt.active{
      border-color: rgba(109,94,252,.65);
      background: rgba(109,94,252,.10);
    }

    /* Lock badge (no emojis) */
    .lock{
      position:absolute; top:10px; right:10px;
      font-size:12px;
      border:1px solid rgba(245,197,66,.35);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(245,197,66,.08);
      color: var(--plus);
      font-weight:900;
    }

    .bar{
      width:100%;
      height:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
    }

    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.5;
    }

    .divider{border:none;border-top:1px solid var(--line); margin:14px 0}

    .badge{
      font-weight:900;
      font-size:12px;
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      margin-right:8px;
    }
    .badge.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
    .badge.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }
    .badge.free{ color: var(--free); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.03); }

    /* ===== File picker corporativo ===== */
    .fileRow{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px;
    }
    .fileInputHidden{
      position:absolute;
      width:1px;height:1px;
      opacity:0;
      pointer-events:none;
    }
    .fileBtn{
      white-space:nowrap;
      padding:10px 14px;
      border-radius:12px;
    }
    .fileMeta{min-width:0; flex:1}
    .fileName{
      font-weight:900;
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .fileHint{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    /* ===== Player custom WarMaster ===== */
    .player{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
    }
    .playerPro{
      border-color: rgba(109,94,252,.20);
      background:
        radial-gradient(420px 120px at 0% 0%, rgba(109,94,252,.12), transparent 65%),
        rgba(255,255,255,.03);
    }

    .pBtn{
      width:40px;height:40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .pBtn:hover{background: rgba(255,255,255,.05)}

    .pMid{flex:1; min-width:0}
    .pTimeRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
      color: var(--muted);
      font-size:12px;
    }
    .pSep{opacity:.6}

    .pSeek{
      width:100%;
      accent-color: var(--brand);
      height: 18px;
    }
    .pVol{
      width:90px;
      accent-color: var(--brand2);
      height: 18px;
    }
    @media (max-width:520px){
      .pVol{display:none;}
    }

    .player audio{display:none;} /* ocultamos control nativo */

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(560px, 100%);
      background: rgba(18,20,27,.98);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .body{padding:16px 18px}
    .priceBtn{ width:100%; justify-content:center; }

    /* ===== EQ LIVE (Plugin panel) ===== */
    .eqPanel{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,20,27,.65);
      border-radius:18px;
      overflow:hidden;
    }
    .eqTop{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 260px at 10% 0%, rgba(109,94,252,.18), transparent 55%),
        radial-gradient(900px 260px at 90% 0%, rgba(45,212,191,.12), transparent 55%),
        rgba(255,255,255,.02);
    }
    .eqTitle{font-weight:900; letter-spacing:.3px}
    .eqSub{color: rgba(255,255,255,.60); font-size:12px; margin-top:2px}
    #eqViz{
      width:100%;
      height:220px;
      display:block;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }

    /* 8 knobs */
    .eqBottom{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:12px;
      background: rgba(255,255,255,.02);
    }
    @media (max-width: 1100px){
      .eqBottom{grid-template-columns: repeat(4, 1fr);}
    }
    @media (max-width: 620px){
      .eqBottom{grid-template-columns: repeat(2, 1fr);}
    }

    .knobCol{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
      text-align:center;
    }
    .kLabel{margin-top:10px; font-weight:900; font-size:12px; letter-spacing:.2px}
    .kVal{margin-top:4px; color: rgba(255,255,255,.65); font-size:12px}

    .knob{
      width:74px; height:74px;
      margin:0 auto;
      border-radius:999px;
      position:relative;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), transparent 45%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,.25), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.20));
      box-shadow: 0 12px 22px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      touch-action:none;
      user-select:none;
    }
    .knob::after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      width:4px; height:28px;
      background: linear-gradient(180deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
      transform-origin: 50% calc(100% - 2px);
      transform: translate(-50%,-100%) rotate(var(--ang, -120deg));
      border-radius:999px;
      box-shadow: 0 0 10px rgba(109,94,252,.25);
    }

    /* ===== EQ visible, pero desactivado hasta "Procesar" ===== */
    .eqPanel.eqDisabled{ opacity:.90; }
    .eqPanel.eqDisabled .eqBottom{
      filter: grayscale(.25);
      pointer-events:none;
      opacity:.55;
    }
    .eqPanel.eqDisabled #eqViz{ opacity:.55; }

    .eqGateNote{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.65);
      line-height:1.5;
    }
    .eqGateBadge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      font-weight:900;
      margin-right:8px;
      white-space:nowrap;
    }
    .eqGateBadge.on{
      border-color: rgba(45,212,191,.25);
      background: rgba(45,212,191,.08);
      color: rgba(45,212,191,.95);
    }
    .eqGateBadge.off{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.80);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span> WarMaster</div>
      <div class="nav">
        <span class="pill" id="apiPill">API: auto</span>
        <span class="pill planPill free" id="planPill">■ FREE</span>
        <button class="btn" id="goHome">Inicio</button>
        <button class="btn" id="goDash">Dashboard</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card" id="cardLeft">
        <div class="head">
          <h2>Nuevo Master</h2>
          <span class="pill" id="statusPill">Listo</span>
        </div>
        <div class="body">

          <label>Archivo (mp3/wav)</label>
          <div class="fileRow">
            <input type="file" id="file" accept="audio/*" class="fileInputHidden"/>
            <button class="btn btnPrimary fileBtn" id="btnPickFile">Elegir archivo</button>
            <div class="fileMeta">
              <div class="fileName" id="fileName">Sin archivo</div>
              <div class="fileHint" id="fileHint">MAX 100MB · 6:00</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <label>Destino / Preset</label>
          <div class="selectGrid" id="targets"></div>

          <div style="height:12px"></div>

          <label>Intensidad</label>
          <div class="selectGrid" id="intensity"></div>

          <div class="note" id="planNote">
            <span class="badge free">■ FREE</span>
            Escucha el master completo. Descarga: 30s.
          </div>

          <hr class="divider"/>

          <div class="row">
            <button class="btn btnPrimary" id="btnMaster">Procesar</button>
            <button class="btn" id="btnReset">Limpiar</button>
          </div>

          <div style="height:12px"></div>
          <div class="bar" aria-label="progreso"><div id="barFill"></div></div>
          <div class="note" id="status">Listo.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="cardRight">
        <div class="head">
          <h2>Resultado</h2>
          <span class="pill" id="resultPill">—</span>
        </div>
        <div class="body">
          <div id="resultEmpty" class="muted">Sube un archivo y presiona “Procesar”.</div>

          <div id="resultBox" style="display:none">

            <label>Original</label>
            <div class="player" id="playerOriginal">
              <button class="pBtn" data-act="play" aria-label="play">▶</button>
              <div class="pMid">
                <div class="pTimeRow">
                  <span class="pTime" data-k="cur">0:00</span>
                  <span class="pSep">/</span>
                  <span class="pTime" data-k="dur">0:00</span>
                </div>
                <input class="pSeek" type="range" min="0" max="1000" value="0" data-act="seek"/>
              </div>
              <input class="pVol" type="range" min="0" max="1" step="0.01" value="1" data-act="vol" aria-label="vol"/>
              <audio id="audioOriginal"></audio>
            </div>

            <div style="height:10px"></div>

            <label>Master</label>
            <div class="player playerPro" id="playerMaster">
              <button class="pBtn" data-act="play" aria-label="play">▶</button>
              <div class="pMid">
                <div class="pTimeRow">
                  <span class="pTime" data-k="cur">0:00</span>
                  <span class="pSep">/</span>
                  <span class="pTime" data-k="dur">0:00</span>
                </div>
                <input class="pSeek" type="range" min="0" max="1000" value="0" data-act="seek"/>
              </div>
              <input class="pVol" type="range" min="0" max="1" step="0.01" value="1" data-act="vol" aria-label="vol"/>
              <audio id="audioMaster"></audio>
            </div>

            <!-- ===== PLUGIN PANEL (visible desde inicio, preview OFF hasta Procesar) ===== -->
            <div class="eqPanel eqDisabled" id="eqPanel">
              <div class="eqTop">
                <div class="eqTitle">EQ Live</div>
                <div class="eqSub">Vista pro (se activa al procesar)</div>
                <canvas id="eqViz" width="900" height="220"></canvas>
                <div class="eqGateNote" id="eqGateNote">
                  <span class="eqGateBadge off" id="eqGateBadge">PREVIEW OFF</span>
                  Activa el preview al presionar “Procesar”.
                </div>
              </div>

              <div class="eqBottom">
                <div class="knobCol">
                  <div class="knob" data-knob="low"></div>
                  <div class="kLabel">LOW</div>
                  <div class="kVal" id="vLow">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="mid"></div>
                  <div class="kLabel">MID</div>
                  <div class="kVal" id="vMid">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="pres"></div>
                  <div class="kLabel">PRESENCE</div>
                  <div class="kVal" id="vPres">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="air"></div>
                  <div class="kLabel">AIR</div>
                  <div class="kVal" id="vAir">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="glue"></div>
                  <div class="kLabel">GLUE</div>
                  <div class="kVal" id="vGlue">0%</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="width"></div>
                  <div class="kLabel">WIDTH</div>
                  <div class="kVal" id="vWidth">100%</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="sat"></div>
                  <div class="kLabel">SAT</div>
                  <div class="kVal" id="vSat">0%</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="out"></div>
                  <div class="kLabel">OUTPUT</div>
                  <div class="kVal" id="vOut">0.0 dB</div>
                </div>
              </div>
            </div>
            <!-- ===== /PLUGIN PANEL ===== -->

            <div class="note" id="unlockHint"></div>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="btnDownloadPreview">Descargar 30s</button>
              <button class="btn btnPlus" id="btnUnlock">◇ Desbloquear</button>
              <button class="btn btnPro" id="btnUpgradeToPro" style="display:none">◆ Upgrade PRO</button>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn btnPrimary" id="btnDownloadFull" style="display:none">Descargar completo</button>
            </div>

            <div class="note" id="backendNote"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal unlock -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="head">
        <h2>Desbloquear descarga</h2>
        <button class="btn" id="closeModal">×</button>
      </div>
      <div class="body">
        <div class="note" style="margin-top:0" id="modalTopNote">
          Estás escuchando el master completo. Para descargar, elige:
        </div>

        <div style="height:12px"></div>

        <button class="btn btnPlus priceBtn" id="buyPlus">◇ Unlock PLUS (por canción)</button>
        <div class="note muted">Desbloquea este master y queda en tu dashboard.</div>

        <div style="height:10px"></div>

        <button class="btn btnPro priceBtn" id="buyPro">◆ Unlock PRO (por canción)</button>
        <div class="note muted">Versión PRO del master (según motor backend).</div>

        <hr class="divider"/>

        <div class="note" id="payMsg"></div>
      </div>
    </div>
  </div>

  <script> 
    // ========= API BASE =========
    function getApiBase() {
      // ✅ En Render, fuerza mismo dominio SIEMPRE (evita WM_API_BASE viejo rompiendo fetch)
      const host = location.hostname.toLowerCase();
      if (host.endsWith("onrender.com")) return "";

      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get("api");
      if (fromQS) return fromQS.replace(/\/+$/,'');

      const stored = localStorage.getItem("WM_API_BASE");
      if (stored) return stored.replace(/\/+$/,'');

      return ""; // same origin
    }
    const API_BASE = getApiBase();
    document.getElementById("apiPill").textContent = "API: " + (API_BASE || "mismo dominio");

    function qsCarry(path){
      const qs = new URLSearchParams(location.search);
      const api = qs.get("api");
      return api ? (path + "?api=" + encodeURIComponent(api)) : path;
    }
    document.getElementById("goHome").onclick = () => location.href = qsCarry("/index.html");
    document.getElementById("goDash").onclick = () => location.href = qsCarry("/dashboard.html");

    async function fetchWithTimeout(url, options={}, timeoutMs=180000) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: ctrl.signal }); }
      finally { clearTimeout(id); }
    }

    // ========= PLAN STATE (dynamic) =========
    let currentPlan = "FREE"; // FREE / PLUS / PRO
    function applyPlanUI(){
      const pill = document.getElementById("planPill");
      pill.classList.remove("free","plus","pro");
      const left = document.getElementById("cardLeft");
      const right = document.getElementById("cardRight");
      left.classList.remove("cardGlowPlus","cardGlowPro");
      right.classList.remove("cardGlowPlus","cardGlowPro");

      if(currentPlan === "PLUS"){
        pill.textContent = "◇ PLUS";
        pill.classList.add("plus");
        left.classList.add("cardGlowPlus");
        right.classList.add("cardGlowPlus");
        document.getElementById("planNote").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Descarga completa habilitada (plan).`;
      } else if(currentPlan === "PRO"){
        pill.textContent = "◆ PRO";
        pill.classList.add("pro");
        left.classList.add("cardGlowPro");
        right.classList.add("cardGlowPro");
        document.getElementById("planNote").innerHTML =
          `<span class="badge pro">◆ PRO</span> Descarga completa habilitada (plan).`;
      } else {
        pill.textContent = "■ FREE";
        pill.classList.add("free");
        document.getElementById("planNote").innerHTML =
          `<span class="badge free">■ FREE</span> Escucha el master completo. Descarga: 30s.`;
      }
    }

    async function loadPlan(){
      try{
        const res = await fetchWithTimeout((API_BASE||"") + "/api/me", {}, 12000);
        if(!res.ok) throw new Error("no /api/me");
        const data = await res.json();
        currentPlan = (data.plan || "FREE").toUpperCase();
        if(!["FREE","PLUS","PRO"].includes(currentPlan)) currentPlan="FREE";
      }catch(e){
        currentPlan = "FREE";
      }
      applyPlanUI();
    }
    loadPlan();

    // ========= UI DATA =========
    const TARGETS = [
      { id:"streaming",  name:"Streaming",  desc:"Balance general", pro:false },
      { id:"warm",       name:"Warm",       desc:"Cuerpo / suavidad", pro:false },
      { id:"bright",     name:"Bright",     desc:"Brillo / presencia", pro:false },
      { id:"heavy",      name:"Heavy",      desc:"Grueso / denso", pro:false },
      { id:"club",       name:"Club",       desc:"Impacto alto", pro:true }
    ];
    const INTENSITIES = [
      { id:"soft",       name:"Suave",      desc:"Más dinámico", pro:true },
      { id:"balanced",   name:"Balanceado", desc:"Default", pro:false },
      { id:"aggressive", name:"Agresivo",   desc:"Más loud", pro:true }
    ];

    let selectedTarget = "streaming";
    let selectedIntensity = "balanced";

    function renderOptions(){
      const tWrap = document.getElementById("targets");
      const iWrap = document.getElementById("intensity");
      tWrap.innerHTML = "";
      iWrap.innerHTML = "";

      TARGETS.forEach(t=>{
        const el = document.createElement("div");
        el.className = "opt" + (t.id===selectedTarget ? " active" : "");
        el.innerHTML = `<b>${t.name}</b><small>${t.desc}</small>` + (t.pro ? `<span class="lock">PLUS / PRO</span>` : "");
        el.onclick = ()=>{
          if (t.pro && currentPlan==="FREE"){
            document.getElementById("backendNote").textContent = "Disponible en PLUS / PRO.";
            return;
          }
          selectedTarget = t.id;
          renderOptions();
        };
        tWrap.appendChild(el);
      });

      INTENSITIES.forEach(i=>{
        const el = document.createElement("div");
        el.className = "opt" + (i.id===selectedIntensity ? " active" : "");
        el.innerHTML = `<b>${i.name}</b><small>${i.desc}</small>` + (i.pro ? `<span class="lock">PLUS / PRO</span>` : "");
        el.onclick = ()=>{
          if (i.pro && currentPlan==="FREE"){
            document.getElementById("backendNote").textContent = "Disponible en PLUS / PRO.";
            return;
          }
          selectedIntensity = i.id;
          renderOptions();
        };
        iWrap.appendChild(el);
      });
    }
    renderOptions();

    // ========= STATE =========
    let lastMasterId = null;
    let paidQuality = null; // null | "PLUS" | "PRO"
    let originalUrl = null;
    let masterUrl = null;
    let previewUrl = null;

    function revoke(u){
      try{ if(u) URL.revokeObjectURL(u); }catch(e){}
    }

    function setStatus(text, pct){
      document.getElementById("status").textContent = text || "";
      document.getElementById("statusPill").textContent = (pct>=100) ? "Listo" : "Procesando";
      document.getElementById("barFill").style.width = Math.max(0, Math.min(100, pct||0)) + "%";
    }

    function resetResult(){
      lastMasterId = null;
      paidQuality = null;

      document.getElementById("resultEmpty").style.display = "";
      document.getElementById("resultBox").style.display = "none";
      document.getElementById("resultPill").textContent = "—";
      document.getElementById("unlockHint").textContent = "";
      document.getElementById("backendNote").textContent = "";
      document.getElementById("btnDownloadFull").style.display = "none";
      document.getElementById("btnUpgradeToPro").style.display = "none";

      const ao = document.getElementById("audioOriginal");
      const am = document.getElementById("audioMaster");
      ao.removeAttribute("src"); am.removeAttribute("src");
      ao.load(); am.load();

      revoke(originalUrl); revoke(masterUrl); revoke(previewUrl);
      originalUrl = null; masterUrl = null; previewUrl = null;

      // EQ vuelve a OFF visual
      if (typeof window.WM_setEqEnabled === "function") window.WM_setEqEnabled(false);
    }
    // ========= PAY (demo) =========
    function openModal(msg){
      document.getElementById("payMsg").textContent = msg || "";
      document.getElementById("modalBack").style.display = "flex";
    }
    function closeModal(){
      document.getElementById("modalBack").style.display = "none";
      document.getElementById("payMsg").textContent = "";
    }
    document.getElementById("closeModal").onclick = closeModal;
    document.getElementById("modalBack").addEventListener("click", (e)=>{
      if(e.target.id === "modalBack") closeModal();
    });

    document.getElementById("btnUnlock").onclick = () => openModal("");

    function afterUnlockUI(){
      const fullBtn = document.getElementById("btnDownloadFull");
      const upBtn = document.getElementById("btnUpgradeToPro");

      if (paidQuality === "PLUS") {
        fullBtn.style.display = "";
        upBtn.style.display = "";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Master desbloqueado. Disponible en dashboard para re-descarga.`;
        return;
      }
      if (paidQuality === "PRO") {
        fullBtn.style.display = "";
        upBtn.style.display = "none";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge pro">◆ PRO</span> Master desbloqueado. Disponible en dashboard para re-descarga.`;
        return;
      }
      if (currentPlan === "PLUS") {
        fullBtn.style.display = "";
        upBtn.style.display = "";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Descarga completa habilitada por plan.`;
        return;
      }
      if (currentPlan === "PRO") {
        fullBtn.style.display = "";
        upBtn.style.display = "none";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge pro">◆ PRO</span> Descarga completa habilitada por plan.`;
        return;
      }

      fullBtn.style.display = "none";
      upBtn.style.display = "none";
      document.getElementById("unlockHint").innerHTML =
        `<span class="badge free">■ FREE</span> Descarga: preview 30s.`;
    }

    function unlock(quality){
      if(!lastMasterId){ alert("Primero procesa un master."); return; }
      paidQuality = quality;
      closeModal();
      afterUnlockUI();
      alert("Demo: unlock simulado. Luego conectamos pagos reales.");
    }

    async function fetchAndDownload(url, filename){
      const r = await fetchWithTimeout(url, {}, 180000);
      if(!r.ok) throw new Error("download fail");
      const blob = await r.blob();
      revoke(previewUrl);
      previewUrl = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = previewUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    document.getElementById("buyPlus").onclick = () => unlock("PLUS");
    document.getElementById("buyPro").onclick  = () => unlock("PRO");

    document.getElementById("btnDownloadPreview").onclick = async () => {
      if(!lastMasterId){ alert("Primero procesa un master."); return; }

      if (currentPlan === "PLUS" || currentPlan === "PRO" || paidQuality === "PLUS" || paidQuality === "PRO") {
        window.open((API_BASE||"") + `/download/${encodeURIComponent(lastMasterId)}`, "_blank");
        return;
      }

      try{
        setStatus("Generando preview...", 70);
        const seconds = 30;
        await fetchAndDownload(
          (API_BASE||"") + `/api/master/preview?master_id=${encodeURIComponent(lastMasterId)}&seconds=${seconds}`,
          "warmaster_preview_30s.wav"
        );
        setStatus("Listo.", 100);
      }catch(e){
        alert("Preview requiere /api/master/preview con seconds (lo ajustamos en backend).");
        setStatus("Listo.", 100);
      }
    };

    document.getElementById("btnDownloadFull").onclick = async () => {
      if(!lastMasterId){ alert("Primero procesa un master."); return; }
      window.open((API_BASE||"") + `/download/${encodeURIComponent(lastMasterId)}`, "_blank");
    };

    // ========= FILE PICKER =========
    const fileInput = document.getElementById("file");
    const btnPick = document.getElementById("btnPickFile");
    const fileNameEl = document.getElementById("fileName");

    btnPick.onclick = () => fileInput.click();

    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0];
      fileNameEl.textContent = f ? f.name : "Sin archivo";

      // Limpia resultados cuando cambias archivo
      resetResult();
      setStatus("Listo.", 0);

      // original preview (local)
      if(f){
        revoke(originalUrl);
        originalUrl = URL.createObjectURL(f);
        const ao = document.getElementById("audioOriginal");
        ao.src = originalUrl;
        ao.load();
      }
    });

    // ========= PLAYER =========
    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec||0));
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function bindPlayer(containerId, audioId){
      const box = document.getElementById(containerId);
      const audio = document.getElementById(audioId);
      if(!box || !audio) return;

      const btn = box.querySelector('[data-act="play"]');
      const seek = box.querySelector('[data-act="seek"]');
      const vol  = box.querySelector('[data-act="vol"]');
      const cur  = box.querySelector('[data-k="cur"]');
      const dur  = box.querySelector('[data-k="dur"]');

      let dragging = false;

      function syncBtn(){
        btn.textContent = audio.paused ? "▶" : "❚❚";
      }

      audio.addEventListener("loadedmetadata", () => {
        dur.textContent = fmtTime(audio.duration);
        cur.textContent = "0:00";
        seek.value = "0";
      });

      audio.addEventListener("timeupdate", () => {
        if(dragging) return;
        cur.textContent = fmtTime(audio.currentTime);
        const p = audio.duration ? (audio.currentTime / audio.duration) : 0;
        seek.value = String(Math.round(p * 1000));
      });

      audio.addEventListener("play", syncBtn);
      audio.addEventListener("pause", syncBtn);
      audio.addEventListener("ended", () => { audio.currentTime = 0; audio.pause(); });

      btn.addEventListener("click", () => {
        document.querySelectorAll("audio").forEach(a => { if(a !== audio) a.pause(); });
        if(audio.paused) audio.play(); else audio.pause();
      });

      seek.addEventListener("input", () => { dragging = true; });
      seek.addEventListener("change", () => {
        dragging = false;
        const p = Number(seek.value) / 1000;
        if(audio.duration) audio.currentTime = p * audio.duration;
      });

      vol.addEventListener("input", () => { audio.volume = Number(vol.value); });
      audio.volume = Number(vol.value);
      syncBtn();
    }

    bindPlayer("playerOriginal", "audioOriginal");
    bindPlayer("playerMaster", "audioMaster");

    // ========= EQ LIVE (visual gate) =========
    const EQ = {
      enabled:false,
      low:0, mid:0, pres:0, air:0,
      glue:0, width:100, sat:0, out:0
    };

    function drawEq(){
      const c = document.getElementById("eqViz");
      if(!c) return;
      const ctx = c.getContext("2d");
      const w = c.width, h = c.height;
      ctx.clearRect(0,0,w,h);

      // grid
      ctx.globalAlpha = 0.25;
      for(let i=1;i<10;i++){
        const x = (w/10)*i;
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let i=1;i<6;i++){
        const y = (h/6)*i;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // curve (simple)
      const pts = [
        {x:0.08, y:EQ.low},
        {x:0.32, y:EQ.mid},
        {x:0.62, y:EQ.pres},
        {x:0.88, y:EQ.air}
      ];
      const mapY = (v)=> (h/2) - (v/12)*(h*0.38);

      ctx.beginPath();
      pts.forEach((p,idx)=>{
        const x = p.x*w;
        const y = mapY(p.y);
        if(idx===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      pts.forEach(p=>{
        const x = p.x*w, y = mapY(p.y);
        ctx.beginPath();
        ctx.arc(x,y,5,0,Math.PI*2);
        ctx.fill();
      });
    }

    function setEqGate(on){
      EQ.enabled = !!on;
      const panel = document.getElementById("eqPanel");
      const badge = document.getElementById("eqGateBadge");
      const note = document.getElementById("eqGateNote");
      if(!panel || !badge || !note) return;

      panel.classList.toggle("eqDisabled", !EQ.enabled);
      badge.classList.toggle("on", EQ.enabled);
      badge.classList.toggle("off", !EQ.enabled);
      badge.textContent = EQ.enabled ? "PREVIEW ON" : "PREVIEW OFF";
      note.lastChild.textContent = EQ.enabled ? " Preview activado." : " Activa el preview al presionar “Procesar”.";
    }

    // expone para otras funciones
    window.WM_setEqEnabled = (on)=>{
      setEqGate(on);
      drawEq();
    };
    window.WM_setEqEnabled(false);

    // Knob handling
    const knobMap = {
      low:  {min:-12,max:12, step:0.1, fmt:(v)=>`${v.toFixed(1)} dB`, out:"vLow"},
      mid:  {min:-12,max:12, step:0.1, fmt:(v)=>`${v.toFixed(1)} dB`, out:"vMid"},
      pres: {min:-12,max:12, step:0.1, fmt:(v)=>`${v.toFixed(1)} dB`, out:"vPres"},
      air:  {min:-12,max:12, step:0.1, fmt:(v)=>`${v.toFixed(1)} dB`, out:"vAir"},
      glue: {min:0,max:100, step:1,   fmt:(v)=>`${Math.round(v)}%`, out:"vGlue"},
      width:{min:50,max:150, step:1,  fmt:(v)=>`${Math.round(v)}%`, out:"vWidth"},
      sat:  {min:0,max:100, step:1,   fmt:(v)=>`${Math.round(v)}%`, out:"vSat"},
      out:  {min:-12,max:6, step:0.1, fmt:(v)=>`${v.toFixed(1)} dB`, out:"vOut"},
    };

    function knobSetVisual(el, norm){
      // norm: 0..1 map to -120..120 deg
      const ang = -120 + norm*240;
      el.style.setProperty("--ang", ang + "deg");
    }

    function setVal(key, val){
      EQ[key] = val;
      const meta = knobMap[key];
      if(meta){
        const out = document.getElementById(meta.out);
        if(out) out.textContent = meta.fmt(val);
      }
      if(["low","mid","pres","air"].includes(key)) drawEq();
    }

    function initKnobs(){
      document.querySelectorAll(".knob").forEach(knob=>{
        const key = knob.getAttribute("data-knob");
        const meta = knobMap[key];
        if(!meta) return;

        // init default values
        const defaults = {
          low:0, mid:0, pres:0, air:0,
          glue:0, width:100, sat:0, out:0
        };
        setVal(key, defaults[key]);

        const toNorm = (v)=> (v - meta.min) / (meta.max - meta.min);
        knobSetVisual(knob, toNorm(EQ[key]));

        let dragging=false;
        let startY=0;
        let startV=0;

        const onDown = (e)=>{
          if(!EQ.enabled) return;
          dragging=true;
          startY = (e.touches? e.touches[0].clientY : e.clientY);
          startV = EQ[key];
          knob.setPointerCapture?.(e.pointerId);
          e.preventDefault();
        };
        const onMove = (e)=>{
          if(!dragging) return;
          const y = (e.touches? e.touches[0].clientY : e.clientY);
          const dy = startY - y;
          const range = meta.max - meta.min;
          const delta = (dy / 160) * range; // sensitivity
          let v = startV + delta;
          v = Math.max(meta.min, Math.min(meta.max, v));
          // snap to step
          v = Math.round(v / meta.step) * meta.step;
          setVal(key, v);
          knobSetVisual(knob, toNorm(v));
          e.preventDefault();
        };
        const onUp = (e)=>{
          if(!dragging) return;
          dragging=false;
          e.preventDefault();
        };

        knob.addEventListener("pointerdown", onDown);
        window.addEventListener("pointermove", onMove);
        window.addEventListener("pointerup", onUp);

        knob.addEventListener("touchstart", onDown, {passive:false});
        window.addEventListener("touchmove", onMove, {passive:false});
        window.addEventListener("touchend", onUp, {passive:false});
      });

      drawEq();
    }
    initKnobs();
    // ========= PROCESS =========
    document.getElementById("btnMaster").onclick = async () => {
      const file = fileInput.files?.[0];
      if(!file){ alert("Selecciona un archivo."); return; }

      resetResult();
      setStatus("Subiendo...", 10);

      try{
        const fd = new FormData();
        fd.append("file", file);

        // backend expects: target/intensity or preset/intensity (se mantiene)
        fd.append("target", selectedTarget);
        fd.append("intensity", selectedIntensity);

        // EQ knobs to backend (si backend los recibe)
        fd.append("k_low",  String(EQ.low));
        fd.append("k_mid",  String(EQ.mid));
        fd.append("k_pres", String(EQ.pres));
        fd.append("k_air",  String(EQ.air));
        fd.append("k_glue", String(EQ.glue));
        fd.append("k_width",String(EQ.width));
        fd.append("k_sat",  String(EQ.sat));
        fd.append("k_out",  String(EQ.out));

        const res = await fetchWithTimeout((API_BASE||"") + "/api/master", {
          method:"POST",
          body: fd
        }, 180000);

        if(!res.ok){
          const t = await res.text().catch(()=> "");
          throw new Error(t || "Error");
        }

        // lee master id desde header (tu backend lo envía así)
        const hdrId = res.headers.get("X-Master-Id") || res.headers.get("x-master-id");
        if(hdrId) lastMasterId = hdrId;

        // respuesta WAV (modo actual)
        const blob = await res.blob();
        setStatus("Finalizando...", 85);

        revoke(masterUrl);
        masterUrl = URL.createObjectURL(blob);

        const am = document.getElementById("audioMaster");
        am.src = masterUrl;
        am.load();

        document.getElementById("resultEmpty").style.display = "none";
        document.getElementById("resultBox").style.display = "";
        document.getElementById("resultPill").textContent = "OK";

        afterUnlockUI();

        setStatus("Listo.", 100);

        // habilita EQ preview
        window.WM_setEqEnabled(true);

      }catch(e){
        alert("Error al masterizar. " + (e?.message || e));
        setStatus("Listo.", 0);
        window.WM_setEqEnabled(false);
      }
    };

    document.getElementById("btnReset").onclick = () => {
      resetResult();
      fileInput.value = "";
      fileNameEl.textContent = "Sin archivo";
      setStatus("Listo.", 0);
      window.WM_setEqEnabled(false);
    };

    // ===== Modal unlock =====
    const modalBack = document.getElementById("modalBack");
    const payMsg = document.getElementById("payMsg");
  </script>
</body>
</html>
