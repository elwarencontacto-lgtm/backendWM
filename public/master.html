<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WarMaster ‚Äî Masterizar</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --panel2:#0f1117;
      --line:#232736;
      --text:#e9ecf3;
      --muted:#a8b0c3;
      --brand:#6d5efc;
      --brand2:#2dd4bf;
      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(109,94,252,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #06070a 70%);
      color:var(--text);
      min-height:100vh;
      padding:18px;
    }
    a{color:inherit}
    .wrap{width:min(1120px,100%); margin:0 auto}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.3px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 0 0 6px rgba(109,94,252,.12);
    }
    .nav{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:800;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.06)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
      border-color: transparent;
    }
    .btn.primary:hover{filter:brightness(1.06)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(18,20,27,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .head h2{margin:0; font-size:16px}
    .body{padding:16px 18px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .input{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
    }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    .selectGrid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    @media (max-width: 520px){ .selectGrid{grid-template-columns:1fr} }
    .opt{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
      position:relative;
    }
    .opt:hover{background: rgba(255,255,255,.05)}
    .opt:active{transform: translateY(1px)}
    .opt b{display:block; margin-bottom:6px}
    .opt small{color:var(--muted)}
    .opt.active{
      border-color: rgba(109,94,252,.65);
      background: rgba(109,94,252,.10);
    }
    .lock{
      position:absolute; top:10px; right:10px;
      font-size:12px; color: var(--warn);
      border:1px solid rgba(245,158,11,.35);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(245,158,11,.08);
    }
    .bar{
      width:100%;
      height:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
    }
    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.5;
    }
    audio{width:100%}
    .divider{border:none;border-top:1px solid var(--line); margin:14px 0}
    .badgeOk{
      color: var(--ok);
      font-weight:800;
      font-size:12px;
    }
    .badgeWarn{
      color: var(--warn);
      font-weight:800;
      font-size:12px;
    }
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(560px, 100%);
      background: rgba(18,20,27,.98);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .body{padding:16px 18px}
    .priceBtn{
      width:100%;
      justify-content:center;
    }
    .danger{
      color: var(--bad);
      font-weight:800;
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span> WarMaster</div>
      <div class="nav">
        <span class="pill" id="apiPill">API: auto</span>
        <button class="btn" id="goHome">üè† Inicio</button>
        <button class="btn" id="goDash">üìÅ Dashboard</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Upload + settings -->
      <div class="card">
        <div class="head">
          <h2>Nuevo Master</h2>
          <span class="pill" id="planPill">Plan: FREE</span>
        </div>
        <div class="body">
          <label>Archivo de audio (mp3/wav)</label>
          <input class="input" type="file" id="file" accept="audio/*"/>

          <div style="height:12px"></div>

          <label>Destino / Target</label>
          <div class="selectGrid" id="targets">
            <!-- injected -->
          </div>

          <div style="height:12px"></div>

          <label>Intensidad (PLUS/PRO)</label>
          <div class="selectGrid" id="intensity">
            <!-- injected -->
          </div>

          <div class="note">
            FREE: puedes <b>escuchar</b> el master completo, pero solo <b>descargas 20s</b>.<br/>
            PLUS/PRO: descarga completa. Si haces un master nuevo (nuevo render), se vuelve a cobrar.
          </div>

          <hr class="divider"/>

          <div class="row">
            <button class="btn primary" id="btnMaster">‚ö° Masterizar</button>
            <button class="btn" id="btnReset">üßπ Limpiar</button>
          </div>

          <div style="height:12px"></div>
          <div class="bar" aria-label="progreso"><div id="barFill"></div></div>
          <div class="note" id="status">Listo.</div>
        </div>
      </div>

      <!-- RIGHT: Result -->
      <div class="card">
        <div class="head">
          <h2>Resultado</h2>
          <span class="pill" id="resultPill">‚Äî</span>
        </div>
        <div class="body">
          <div id="resultEmpty" class="muted">Sube un archivo y presiona ‚ÄúMasterizar‚Äù.</div>

          <div id="resultBox" style="display:none">
            <label>Original</label>
            <audio id="audioOriginal" controls></audio>

            <div style="height:10px"></div>

            <label>Master</label>
            <audio id="audioMaster" controls></audio>

            <div class="note" id="unlockHint"></div>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="btnDownloadPreview">‚¨áÔ∏è Descargar 20s (FREE)</button>
              <button class="btn primary" id="btnUnlock">üîì Desbloquear descarga completa</button>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnDownloadFull" style="display:none">‚¨áÔ∏è Descargar completo</button>
              <button class="btn" id="btnUpgradeToPro" style="display:none">‚¨ÜÔ∏è Upgrade a PRO (pagar diferencia)</button>
            </div>

            <div class="note" id="backendNote"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal unlock -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="head">
        <h2>Desbloquear descarga</h2>
        <button class="btn" id="closeModal">‚úñ</button>
      </div>
      <div class="body">
        <div class="note" style="margin-top:0">
          Est√°s escuchando el master completo. Para descargarlo, elige una opci√≥n:
        </div>

        <div style="height:12px"></div>

        <button class="btn priceBtn" id="buyPlus">üîì Unlock PLUS (por canci√≥n)</button>
        <div class="note muted">Desbloquea este master (re-descarga desde dashboard).</div>

        <div style="height:10px"></div>

        <button class="btn primary priceBtn" id="buyPro">üíé Unlock PRO (por canci√≥n)</button>
        <div class="note muted">Mejor motor/controles (seg√∫n backend).</div>

        <hr class="divider"/>

        <div class="row">
          <button class="btn" id="subPlus">üü° Suscripci√≥n PLUS</button>
          <button class="btn" id="subPro">üíé Suscripci√≥n PRO</button>
        </div>

        <div class="note" id="payMsg"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= API / helpers =========
    function getApiBase() {
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get("api");
      if (fromQS) return fromQS.replace(/\/+$/,'');
      const stored = localStorage.getItem("WM_API_BASE");
      if (stored) return stored.replace(/\/+$/,'');
      return ""; // same origin
    }
    const API_BASE = getApiBase();
    document.getElementById("apiPill").textContent = "API: " + (API_BASE || "mismo dominio");

    async function fetchWithTimeout(url, options={}, timeoutMs=180000) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        return await fetch(url, { ...options, signal: ctrl.signal });
      } finally {
        clearTimeout(id);
      }
    }
    function authHeaders(){
      const t = localStorage.getItem("WM_TOKEN") || "";
      return t ? {"Authorization":"Bearer "+t} : {};
    }
    function qsCarry(path){
      const qs = new URLSearchParams(location.search);
      const api = qs.get("api");
      return api ? (path + "?api=" + encodeURIComponent(api)) : path;
    }

    document.getElementById("goHome").onclick = () => location.href = qsCarry("/index.html");
    document.getElementById("goDash").onclick = () => location.href = qsCarry("/dashboard.html");

    // ========= UI data =========
    const TARGETS = [
      {id:"spotify", name:"Spotify / YouTube", desc:"Target -14 LUFS", lock:false},
      {id:"apple", name:"Apple Music", desc:"Sound Check ‚âà -16 LUFS", lock:false},
      {id:"club", name:"Club", desc:"Impacto alto (-8 a -9 LUFS)", lock:true},
      {id:"radio", name:"Radio", desc:"M√°s presencia / densidad", lock:true},
    ];
    const INTENSITIES = [
      {id:"soft", name:"Suave", desc:"m√°s din√°mico", lock:true},
      {id:"balanced", name:"Balanceado", desc:"default", lock:true},
      {id:"aggressive", name:"Agresivo", desc:"m√°s loud", lock:true},
    ];

    let selectedTarget = "spotify";
    let selectedIntensity = "balanced";

    function renderOptions(){
      const tBox = document.getElementById("targets");
      tBox.innerHTML = "";
      TARGETS.forEach(o=>{
        const div = document.createElement("div");
        div.className = "opt" + (o.id===selectedTarget ? " active" : "");
        div.innerHTML = `<b>${o.name}</b><small>${o.desc}</small>` + (o.lock ? `<span class="lock">PLUS/PRO</span>` : "");
        div.onclick = () => {
          if (o.lock && currentPlan === "FREE") {
            openModal("Este preset est√° disponible en PLUS/PRO.");
            return;
          }
          selectedTarget = o.id;
          renderOptions();
        };
        tBox.appendChild(div);
      });

      const iBox = document.getElementById("intensity");
      iBox.innerHTML = "";
      INTENSITIES.forEach(o=>{
        const div = document.createElement("div");
        div.className = "opt" + (o.id===selectedIntensity ? " active" : "");
        div.innerHTML = `<b>${o.name}</b><small>${o.desc}</small>` + (o.lock ? `<span class="lock">PLUS/PRO</span>` : "");
        div.onclick = () => {
          if (o.lock && currentPlan === "FREE") {
            openModal("La intensidad est√° disponible en PLUS/PRO.");
            return;
          }
          selectedIntensity = o.id;
          renderOptions();
        };
        iBox.appendChild(div);
      });
    }

    // ========= State =========
    let currentPlan = "FREE";      // FREE / PLUS / PRO (from /api/me if exists)
    let lastMasterId = null;       // returned by backend (ideal)
    let masterUrl = null;          // objectURL to play master
    let originalUrl = null;        // objectURL to play original
    let previewUrl = null;         // objectURL for 20s preview (if backend returns)
    let paidQuality = null;        // null / "PLUS" / "PRO" for this master

    function revoke(url){
      try { if(url) URL.revokeObjectURL(url); } catch(e){}
    }
    function resetResult(){
      lastMasterId = null;
      paidQuality = null;
      document.getElementById("resultEmpty").style.display = "";
      document.getElementById("resultBox").style.display = "none";
      document.getElementById("resultPill").textContent = "‚Äî";
      document.getElementById("unlockHint").textContent = "";
      document.getElementById("backendNote").textContent = "";
      document.getElementById("btnDownloadFull").style.display = "none";
      document.getElementById("btnUpgradeToPro").style.display = "none";

      const ao = document.getElementById("audioOriginal");
      const am = document.getElementById("audioMaster");
      ao.removeAttribute("src");
      am.removeAttribute("src");
      ao.load(); am.load();

      revoke(originalUrl); revoke(masterUrl); revoke(previewUrl);
      originalUrl = null; masterUrl = null; previewUrl = null;
    }

    function setStatus(msg, pct){
      document.getElementById("status").textContent = msg;
      const p = Math.max(0, Math.min(100, pct ?? 0));
      document.getElementById("barFill").style.width = p + "%";
    }

    // ========= Modal =========
    const modalBack = document.getElementById("modalBack");
    const payMsg = document.getElementById("payMsg");
    function openModal(msg){
      payMsg.textContent = msg || "";
      modalBack.style.display = "flex";
    }
    function closeModal(){
      modalBack.style.display = "none";
      payMsg.textContent = "";
    }
    document.getElementById("closeModal").onclick = closeModal;
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(); });

    document.getElementById("btnUnlock").onclick = () => openModal("");

    // ========= Unlock / subscribe hooks (backend needed) =========
    async function postJSON(path, body){
      const res = await fetchWithTimeout((API_BASE||"") + path, {
        method:"POST",
        headers: {"Content-Type":"application/json", ...authHeaders()},
        body: JSON.stringify(body||{})
      }, 180000);
      return res;
    }

    async function unlock(quality){ // PLUS or PRO
      if(!lastMasterId){
        openModal("Primero debes masterizar.");
        return;
      }
      payMsg.textContent = "Procesando pago / unlock...";
      try{
        // Esperado: backend crea pago o marca unlock; responde {ok:true, quality, download_url?}
        const res = await postJSON("/api/unlock", { master_id:lastMasterId, quality });
        if(!res.ok) throw new Error("unlock fail");
        const data = await res.json();
        paidQuality = quality;
        closeModal();
        afterUnlock(data);
      }catch(e){
        // Fallback: si no existe backend de pagos
        payMsg.innerHTML = "‚ö†Ô∏è Backend de pagos no disponible a√∫n. Cuando lo activemos, este bot√≥n desbloquear√° la descarga completa.";
      }
    }

    async function upgradeToPro(){
      if(!lastMasterId){
        alert("Primero masteriza.");
        return;
      }
      try{
        const res = await postJSON("/api/upgrade", { master_id:lastMasterId, from:"PLUS", to:"PRO" });
        if(!res.ok) throw new Error("upgrade fail");
        const data = await res.json();
        paidQuality = "PRO";
        afterUnlock(data);
      }catch(e){
        alert("Upgrade no disponible a√∫n (falta endpoint /api/upgrade).");
      }
    }

    function afterUnlock(data){
      // Si el backend devuelve download_url, √∫salo. Si no, habilitamos descarga full con el blob que ya tenemos.
      document.getElementById("unlockHint").innerHTML = `<span class="badgeOk">Desbloqueado:</span> ${paidQuality} (este master quedar√° en tu dashboard).`;
      document.getElementById("btnDownloadFull").style.display = "";
      if (paidQuality === "PLUS") {
        document.getElementById("btnUpgradeToPro").style.display = "";
      } else {
        document.getElementById("btnUpgradeToPro").style.display = "none";
      }
    }

    document.getElementById("buyPlus").onclick = () => unlock("PLUS");
    document.getElementById("buyPro").onclick = () => unlock("PRO");
    document.getElementById("subPlus").onclick = () => payMsg.textContent = "Suscripci√≥n PLUS: lo conectamos cuando definamos pasarela (Webpay/MercadoPago).";
    document.getElementById("subPro").onclick = () => payMsg.textContent = "Suscripci√≥n PRO: lo conectamos cuando definamos pasarela (Webpay/MercadoPago).";

    document.getElementById("btnUpgradeToPro").onclick = upgradeToPro;

    // ========= Download buttons =========
    function downloadBlobUrl(url, filename){
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    document.getElementById("btnDownloadFull").onclick = () => {
      if(!masterUrl){
        alert("No hay master listo.");
        return;
      }
      downloadBlobUrl(masterUrl, "warmaster_master_full.wav");
    };

    document.getElementById("btnDownloadPreview").onclick = async () => {
      // Ideal: backend entrega un preview de 20s (para cumplir tu l√≥gica actual)
      // Endpoint sugerido: GET /api/master/preview?master_id=...
      if(!lastMasterId){
        alert("Primero masteriza.");
        return;
      }
      try{
        setStatus("Generando preview 20s...", 70);
        const res = await fetchWithTimeout((API_BASE||"") + `/api/master/preview?master_id=${encodeURIComponent(lastMasterId)}`, {
          headers: {...authHeaders()}
        }, 180000);
        if(!res.ok) throw new Error("no preview");
        const blob = await res.blob();
        revoke(previewUrl);
        previewUrl = URL.createObjectURL(blob);
        downloadBlobUrl(previewUrl, "warmaster_preview_20s.mp3");
        setStatus("Preview descargado.", 100);
      }catch(e){
        alert("Preview 20s requiere endpoint /api/master/preview (lo agregamos en el backend).");
        setStatus("Listo.", 100);
      }
    };

    // ========= Master flow =========
    document.getElementById("btnReset").onclick = () => {
      document.getElementById("file").value = "";
      resetResult();
      setStatus("Listo.", 0);
    };

    document.getElementById("btnMaster").onclick = async () => {
      const file = document.getElementById("file").files?.[0];
      if(!file){
        alert("Selecciona un archivo.");
        return;
      }

      // FREE no permite seleccionar preset lock / intensidad lock (ya bloqueado en UI)
      // Aqu√≠ solo enviamos lo seleccionado.

      resetResult();
      setStatus("Subiendo y procesando...", 10);

      // Original audio preview (local)
      revoke(originalUrl);
      originalUrl = URL.createObjectURL(file);
      const ao = document.getElementById("audioOriginal");
      ao.src = originalUrl;
      ao.load();

      // Build form to /api/master (tu endpoint actual)
      const form = new FormData();
      form.append("file", file);

      // Campos sugeridos (el backend puede ignorarlos si a√∫n no los implementas)
      form.append("target", selectedTarget);
      form.append("intensity", selectedIntensity);
      form.append("requested_quality", currentPlan); // FREE / PLUS / PRO (seg√∫n sesi√≥n)
      // Tip: si tu backend hoy usa otro nombre de campo, lo adaptamos despu√©s.

      try{
        setStatus("Procesando (FFmpeg)...", 35);

        const res = await fetchWithTimeout((API_BASE||"") + "/api/master", {
          method:"POST",
          body: form,
          headers: { ...authHeaders() }
        }, 180000);

        if(!res.ok){
          const txt = await res.text().catch(()=>"(sin detalle)");
          throw new Error(txt);
        }

        // Opcional: si el backend devuelve header X-Master-Id o JSON, pero hoy puede devolver blob directo.
        // Vamos a intentar leer header primero:
        const hdrId = res.headers.get("X-Master-Id") || res.headers.get("x-master-id");
        if (hdrId) lastMasterId = hdrId;

        // Si el backend devolvi√≥ JSON en vez de blob:
        const contentType = (res.headers.get("Content-Type")||"").toLowerCase();
        let blob;

        if(contentType.includes("application/json")){
          const data = await res.json();
          // Esperado: { master_id, url } o { master_id, file_base64 } etc.
          lastMasterId = data.master_id || lastMasterId;
          if (data.url){
            // si entrega URL directa
            const r2 = await fetchWithTimeout(data.url, {}, 180000);
            blob = await r2.blob();
          } else {
            throw new Error("JSON recibido pero falta url/blob. Ajustamos backend.");
          }
        } else {
          blob = await res.blob();
        }

        setStatus("Finalizando...", 85);

        revoke(masterUrl);
        masterUrl = URL.createObjectURL(blob);
        const am = document.getElementById("audioMaster");
        am.src = masterUrl;
        am.load();

        document.getElementById("resultEmpty").style.display = "none";
        document.getElementById("resultBox").style.display = "";
        document.getElementById("resultPill").textContent = "Master listo";
        document.getElementById("unlockHint").innerHTML = `<span class="badgeWarn">FREE:</span> Puedes escuchar completo. Descarga completa se desbloquea con pago o plan.`;
        document.getElementById("backendNote").textContent = lastMasterId
          ? "ID Master: " + lastMasterId
          : "Tip: para dashboard/pagos, el backend deber√≠a entregar master_id (header X-Master-Id o JSON).";

        setStatus("Listo ‚úÖ", 100);

        // Si el usuario YA est√° en plan PLUS/PRO (por /api/me), habilitar full:
        if(currentPlan === "PLUS" || currentPlan === "PRO"){
          paidQuality = currentPlan;
          document.getElementById("btnDownloadFull").style.display = "";
          document.getElementById("btnUpgradeToPro").style.display = (currentPlan === "PLUS") ? "" : "none";
          document.getElementById("unlockHint").innerHTML = `<span class="badgeOk">Plan ${currentPlan}:</span> Descarga completa habilitada.`;
        }
      }catch(err){
        console.error(err);
        setStatus("Error: " + (err?.message || "fallo"), 0);
        alert("Error al masterizar. Revisa consola/logs. " + (err?.message || ""));
      }
    };

    // ========= Load plan from backend if exists =========
    (async () => {
      try{
        const res = await fetchWithTimeout((API_BASE||"") + "/api/me", {
          headers: {...authHeaders()}
        }, 12000);
        if(!res.ok) throw new Error("no me");
        const data = await res.json();
        currentPlan = (data.plan || data.tier || "FREE").toUpperCase();
      }catch(e){
        currentPlan = "FREE";
      }
      document.getElementById("planPill").textContent = "Plan: " + currentPlan;
      renderOptions();
    })();

    // Clean up on unload
    window.addEventListener("beforeunload", () => {
      revoke(originalUrl); revoke(masterUrl); revoke(previewUrl);
    });
  </script>
</body>
</html>
