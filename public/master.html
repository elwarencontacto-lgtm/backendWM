<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WarMaster | Master</title>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --panel2:#0f1117;
      --line:#232736;
      --text:#e9ecf3;
      --muted:#a8b0c3;

      /* Brand base */
      --brand:#6d5efc;
      --brand2:#2dd4bf;

      /* Plan colors (official) */
      --free:#ffffff;   /* FREE blanco */
      --plus:#f5c542;   /* PLUS amarillo */
      --pro:#4ea8ff;    /* PRO azul */

      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#22c55e;

      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(109,94,252,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #06070a 70%);
      color:var(--text);
      min-height:100vh;
      padding:18px;
    }

    .wrap{width:min(1120px,100%); margin:0 auto}
    a{color:inherit}

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.3px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 0 0 6px rgba(109,94,252,.12);
    }
    .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .pill{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }

    /* Plan pill */
    .planPill{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      font-weight:900;
    }
    .planPill.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
    .planPill.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }
    .planPill.free{ color: var(--free); border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.03); }

    /* Card + optional plan glow */
    .card{
      background: rgba(18,20,27,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardGlowPlus{ box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(245,197,66,.18), 0 0 24px rgba(245,197,66,.10); }
    .cardGlowPro{  box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(78,168,255,.18), 0 0 24px rgba(78,168,255,.10); }

    .head{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .head h2{margin:0; font-size:16px}

    .body{padding:16px 18px}
    .muted{color:var(--muted)}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:900;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.06)}
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Plan buttons accents */
    .btnPlus{
      border-color: rgba(245,197,66,.45);
      background: rgba(245,197,66,.10);
      color: var(--plus);
    }
    .btnPro{
      border-color: rgba(78,168,255,.45);
      background: rgba(78,168,255,.10);
      color: var(--pro);
    }

    .btnPrimary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
      color: #fff;
    }
    .btnPrimary:hover{filter:brightness(1.06)}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .selectGrid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    @media (max-width: 520px){ .selectGrid{grid-template-columns:1fr} }

    .opt{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
      position:relative;
    }
    .opt:hover{background: rgba(255,255,255,.05)}
    .opt:active{transform: translateY(1px)}
    .opt b{display:block; margin-bottom:6px}
    .opt small{color:var(--muted)}
    .opt.active{
      border-color: rgba(109,94,252,.65);
      background: rgba(109,94,252,.10);
    }

    /* Lock badge (no emojis) */
    .lock{
      position:absolute; top:10px; right:10px;
      font-size:12px;
      border:1px solid rgba(245,197,66,.35);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(245,197,66,.08);
      color: var(--plus);
      font-weight:900;
    }

    .bar{
      width:100%;
      height:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
    }

    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.5;
    }

    .divider{border:none;border-top:1px solid var(--line); margin:14px 0}

    .badge{
      font-weight:900;
      font-size:12px;
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      margin-right:8px;
    }
    .badge.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
    .badge.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }
    .badge.free{ color: var(--free); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.03); }

    /* ===== File picker corporativo ===== */
    .fileRow{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px;
    }
    .fileInputHidden{
      position:absolute;
      width:1px;height:1px;
      opacity:0;
      pointer-events:none;
    }
    .fileBtn{
      white-space:nowrap;
      padding:10px 14px;
      border-radius:12px;
    }
    .fileMeta{min-width:0; flex:1}
    .fileName{
      font-weight:900;
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .fileHint{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    /* ===== Player custom WarMaster ===== */
    .player{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
    }
    .playerPro{
      border-color: rgba(109,94,252,.20);
      background:
        radial-gradient(420px 120px at 0% 0%, rgba(109,94,252,.12), transparent 65%),
        rgba(255,255,255,.03);
    }

    .pBtn{
      width:40px;height:40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      color: var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .pBtn:hover{background: rgba(255,255,255,.05)}

    .pMid{flex:1; min-width:0}
    .pTimeRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
      color: var(--muted);
      font-size:12px;
    }
    .pSep{opacity:.6}

    .pSeek{
      width:100%;
      accent-color: var(--brand);
      height: 18px;
    }
    .pVol{
      width:90px;
      accent-color: var(--brand2);
      height: 18px;
    }
    @media (max-width:520px){
      .pVol{display:none;}
    }

    .player audio{display:none;} /* ocultamos control nativo */

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(560px, 100%);
      background: rgba(18,20,27,.98);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .body{padding:16px 18px}
    .priceBtn{ width:100%; justify-content:center; }

    /* ===== EQ LIVE (Plugin panel) ===== */
    .eqPanel{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(18,20,27,.65);
      border-radius:18px;
      overflow:hidden;
    }
    .eqTop{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 260px at 10% 0%, rgba(109,94,252,.18), transparent 55%),
        radial-gradient(900px 260px at 90% 0%, rgba(45,212,191,.12), transparent 55%),
        rgba(255,255,255,.02);
    }
    .eqTitle{font-weight:900; letter-spacing:.3px}
    .eqSub{color: rgba(255,255,255,.60); font-size:12px; margin-top:2px}
    #eqViz{
      width:100%;
      height:220px;
      display:block;
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }

    /* 8 knobs */
    .eqBottom{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:12px;
      background: rgba(255,255,255,.02);
    }
    @media (max-width: 1100px){
      .eqBottom{grid-template-columns: repeat(4, 1fr);}
    }
    @media (max-width: 620px){
      .eqBottom{grid-template-columns: repeat(2, 1fr);}
    }

    .knobCol{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
      text-align:center;
    }
    .kLabel{margin-top:10px; font-weight:900; font-size:12px; letter-spacing:.2px}
    .kVal{margin-top:4px; color: rgba(255,255,255,.65); font-size:12px}

    .knob{
      width:74px; height:74px;
      margin:0 auto;
      border-radius:999px;
      position:relative;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), transparent 45%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,.25), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.20));
      box-shadow: 0 12px 22px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      touch-action:none;
      user-select:none;
    }
    .knob::after{
      content:"";
      position:absolute;
      left:50%; top:50%;
      width:4px; height:28px;
      background: linear-gradient(180deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
      transform-origin: 50% calc(100% - 2px);
      transform: translate(-50%,-100%) rotate(var(--ang, -120deg));
      border-radius:999px;
      box-shadow: 0 0 10px rgba(109,94,252,.25);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span> WarMaster</div>
      <div class="nav">
        <span class="pill" id="apiPill">API: auto</span>
        <span class="pill planPill free" id="planPill">■ FREE</span>
        <button class="btn" id="goHome">Inicio</button>
        <button class="btn" id="goDash">Dashboard</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card" id="cardLeft">
        <div class="head">
          <h2>Nuevo Master</h2>
          <span class="pill" id="statusPill">Listo</span>
        </div>
        <div class="body">

          <label>Archivo (mp3/wav)</label>
          <div class="fileRow">
            <input type="file" id="file" accept="audio/*" class="fileInputHidden"/>
            <button class="btn btnPrimary fileBtn" id="btnPickFile">Elegir archivo</button>
            <div class="fileMeta">
              <div class="fileName" id="fileName">Sin archivo</div>
              <div class="fileHint" id="fileHint">MAX 100MB · 6:00</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <label>Destino / Preset</label>
          <div class="selectGrid" id="targets"></div>

          <div style="height:12px"></div>

          <label>Intensidad</label>
          <div class="selectGrid" id="intensity"></div>

          <div class="note" id="planNote">
            <span class="badge free">■ FREE</span>
            Escucha el master completo. Descarga: 20s.
          </div>

          <hr class="divider"/>

          <div class="row">
            <button class="btn btnPrimary" id="btnMaster">Procesar</button>
            <button class="btn" id="btnReset">Limpiar</button>
          </div>

          <div style="height:12px"></div>
          <div class="bar" aria-label="progreso"><div id="barFill"></div></div>
          <div class="note" id="status">Listo.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="cardRight">
        <div class="head">
          <h2>Resultado</h2>
          <span class="pill" id="resultPill">—</span>
        </div>
        <div class="body">
          <div id="resultEmpty" class="muted">Sube un archivo y presiona “Procesar”.</div>

          <div id="resultBox" style="display:none">

            <label>Original</label>
            <div class="player" id="playerOriginal">
              <button class="pBtn" data-act="play" aria-label="play">▶</button>
              <div class="pMid">
                <div class="pTimeRow">
                  <span class="pTime" data-k="cur">0:00</span>
                  <span class="pSep">/</span>
                  <span class="pTime" data-k="dur">0:00</span>
                </div>
                <input class="pSeek" type="range" min="0" max="1000" value="0" data-act="seek"/>
              </div>
              <input class="pVol" type="range" min="0" max="1" step="0.01" value="1" data-act="vol" aria-label="vol"/>
              <audio id="audioOriginal"></audio>
            </div>

            <div style="height:10px"></div>

            <label>Master</label>
            <div class="player playerPro" id="playerMaster">
              <button class="pBtn" data-act="play" aria-label="play">▶</button>
              <div class="pMid">
                <div class="pTimeRow">
                  <span class="pTime" data-k="cur">0:00</span>
                  <span class="pSep">/</span>
                  <span class="pTime" data-k="dur">0:00</span>
                </div>
                <input class="pSeek" type="range" min="0" max="1000" value="0" data-act="seek"/>
              </div>
              <input class="pVol" type="range" min="0" max="1" step="0.01" value="1" data-act="vol" aria-label="vol"/>
              <audio id="audioMaster"></audio>
            </div>

            <!-- ===== PLUGIN PANEL ===== -->
            <div class="eqPanel" id="eqPanel">
              <div class="eqTop">
                <div class="eqTitle">EQ Live</div>
                <div class="eqSub">Ajuste en tiempo real (preview)</div>
                <canvas id="eqViz" width="900" height="220"></canvas>
              </div>

              <div class="eqBottom">
                <div class="knobCol">
                  <div class="knob" data-knob="low"></div>
                  <div class="kLabel">LOW</div>
                  <div class="kVal" id="vLow">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="mid"></div>
                  <div class="kLabel">MID</div>
                  <div class="kVal" id="vMid">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="pres"></div>
                  <div class="kLabel">PRESENCE</div>
                  <div class="kVal" id="vPres">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="air"></div>
                  <div class="kLabel">AIR</div>
                  <div class="kVal" id="vAir">0.0 dB</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="glue"></div>
                  <div class="kLabel">GLUE</div>
                  <div class="kVal" id="vGlue">0%</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="width"></div>
                  <div class="kLabel">WIDTH</div>
                  <div class="kVal" id="vWidth">100%</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="sat"></div>
                  <div class="kLabel">SAT</div>
                  <div class="kVal" id="vSat">0%</div>
                </div>

                <div class="knobCol">
                  <div class="knob" data-knob="out"></div>
                  <div class="kLabel">OUTPUT</div>
                  <div class="kVal" id="vOut">0.0 dB</div>
                </div>
              </div>
            </div>
            <!-- ===== /PLUGIN PANEL ===== -->

            <div class="note" id="unlockHint"></div>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="btnDownloadPreview">Descargar 20s</button>
              <button class="btn btnPlus" id="btnUnlock">◇ Desbloquear</button>
              <button class="btn btnPro" id="btnUpgradeToPro" style="display:none">◆ Upgrade PRO</button>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn btnPrimary" id="btnDownloadFull" style="display:none">Descargar completo</button>
            </div>

            <div class="note" id="backendNote"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal unlock -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="head">
        <h2>Desbloquear descarga</h2>
        <button class="btn" id="closeModal">×</button>
      </div>
      <div class="body">
        <div class="note" style="margin-top:0" id="modalTopNote">
          Estás escuchando el master completo. Para descargar, elige:
        </div>

        <div style="height:12px"></div>

        <button class="btn btnPlus priceBtn" id="buyPlus">◇ Unlock PLUS (por canción)</button>
        <div class="note muted">Desbloquea este master y queda en tu dashboard.</div>

        <div style="height:10px"></div>

        <button class="btn btnPro priceBtn" id="buyPro">◆ Unlock PRO (por canción)</button>
        <div class="note muted">Versión PRO del master (según motor backend).</div>

        <hr class="divider"/>

        <div class="note" id="payMsg"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= API BASE =========
    function getApiBase() {
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get("api");
      if (fromQS) return fromQS.replace(/\/+$/,'');
      const stored = localStorage.getItem("WM_API_BASE");
      if (stored) return stored.replace(/\/+$/,'');
      return ""; // same origin
    }
    const API_BASE = getApiBase();
    document.getElementById("apiPill").textContent = "API: " + (API_BASE || "mismo dominio");

    function qsCarry(path){
      const qs = new URLSearchParams(location.search);
      const api = qs.get("api");
      return api ? (path + "?api=" + encodeURIComponent(api)) : path;
    }
    document.getElementById("goHome").onclick = () => location.href = qsCarry("/index.html");
    document.getElementById("goDash").onclick = () => location.href = qsCarry("/dashboard.html");

    async function fetchWithTimeout(url, options={}, timeoutMs=180000) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: ctrl.signal }); }
      finally { clearTimeout(id); }
    }

    // ========= PLAN STATE (dynamic) =========
    let currentPlan = "FREE"; // FREE / PLUS / PRO
    function applyPlanUI(){
      const pill = document.getElementById("planPill");
      pill.classList.remove("free","plus","pro");
      const left = document.getElementById("cardLeft");
      const right = document.getElementById("cardRight");
      left.classList.remove("cardGlowPlus","cardGlowPro");
      right.classList.remove("cardGlowPlus","cardGlowPro");

      if(currentPlan === "PLUS"){
        pill.textContent = "◇ PLUS";
        pill.classList.add("plus");
        left.classList.add("cardGlowPlus");
        right.classList.add("cardGlowPlus");
        document.getElementById("planNote").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Descarga completa habilitada (plan).`;
      } else if(currentPlan === "PRO"){
        pill.textContent = "◆ PRO";
        pill.classList.add("pro");
        left.classList.add("cardGlowPro");
        right.classList.add("cardGlowPro");
        document.getElementById("planNote").innerHTML =
          `<span class="badge pro">◆ PRO</span> Descarga completa habilitada (plan).`;
      } else {
        pill.textContent = "■ FREE";
        pill.classList.add("free");
        document.getElementById("planNote").innerHTML =
          `<span class="badge free">■ FREE</span> Escucha completo. Descarga: 20s.`;
      }
      renderOptions();
    }

    async function loadPlan(){
      try{
        const res = await fetchWithTimeout((API_BASE||"") + "/api/me", {}, 12000);
        if(!res.ok) throw new Error("no /api/me");
        const data = await res.json();
        currentPlan = (data.plan || "FREE").toUpperCase();
        if(!["FREE","PLUS","PRO"].includes(currentPlan)) currentPlan="FREE";
      }catch(e){
        currentPlan = "FREE";
      }
      applyPlanUI();
    }

    // ========= OPTIONS =========
    const TARGETS = [
      {id:"clean",  name:"Streaming", desc:"Balance general", lock:false},
      {id:"warm",   name:"Warm",      desc:"Cuerpo / suavidad", lock:false},
      {id:"bright", name:"Bright",    desc:"Brillo / presencia", lock:false},
      {id:"heavy",  name:"Heavy",     desc:"Grueso / denso", lock:false},
      {id:"club",   name:"Club",      desc:"Impacto alto", lock:true},
    ];

    const INTENSITIES = [
      {id:35, name:"Suave",      desc:"Más dinámico", lock:true},
      {id:55, name:"Balanceado", desc:"Default",      lock:false},
      {id:80, name:"Agresivo",   desc:"Más loud",     lock:true},
    ];

    let selectedTarget = "clean";
    let selectedIntensity = 55;

    function renderOptions(){
      const tBox = document.getElementById("targets");
      tBox.innerHTML = "";
      TARGETS.forEach(o=>{
        const locked = o.lock && currentPlan === "FREE";
        const div = document.createElement("div");
        div.className = "opt" + (o.id===selectedTarget ? " active" : "");
        div.innerHTML =
          `<b>${o.name}</b><small>${o.desc}</small>` +
          (locked ? `<span class="lock">◇ PLUS / ◆ PRO</span>` : "");
        div.onclick = () => {
          if (locked) { openModal("Este preset está disponible en PLUS/PRO o unlock por canción."); return; }
          selectedTarget = o.id;
          renderOptions();
        };
        tBox.appendChild(div);
      });

      const iBox = document.getElementById("intensity");
      iBox.innerHTML = "";
      INTENSITIES.forEach(o=>{
        const locked = o.lock && currentPlan === "FREE";
        const div = document.createElement("div");
        div.className = "opt" + (o.id===selectedIntensity ? " active" : "");
        div.innerHTML =
          `<b>${o.name}</b><small>${o.desc}</small>` +
          (locked ? `<span class="lock">◇ PLUS / ◆ PRO</span>` : "");
        div.onclick = () => {
          if (locked) { openModal("Esta intensidad está disponible en PLUS/PRO."); return; }
          selectedIntensity = o.id;
          renderOptions();
        };
        iBox.appendChild(div);
      });
    }

    // ========= RESULT STATE =========
    let lastMasterId = null;
    let masterUrl = null;
    let originalUrl = null;
    let previewUrl = null;
    let paidQuality = null; // null / PLUS / PRO (unlock)

    function revoke(url){ try{ if(url) URL.revokeObjectURL(url); }catch(e){} }

    function setStatus(msg, pct){
      document.getElementById("status").textContent = msg;
      document.getElementById("statusPill").textContent = msg.length > 18 ? "Procesando" : msg;
      const p = Math.max(0, Math.min(100, pct ?? 0));
      document.getElementById("barFill").style.width = p + "%";
    }

    function resetResult(){
      lastMasterId = null;
      paidQuality = null;

      document.getElementById("resultEmpty").style.display = "";
      document.getElementById("resultBox").style.display = "none";
      document.getElementById("resultPill").textContent = "—";
      document.getElementById("unlockHint").textContent = "";
      document.getElementById("backendNote").textContent = "";
      document.getElementById("btnDownloadFull").style.display = "none";
      document.getElementById("btnUpgradeToPro").style.display = "none";

      const ao = document.getElementById("audioOriginal");
      const am = document.getElementById("audioMaster");
      ao.removeAttribute("src"); am.removeAttribute("src");
      ao.load(); am.load();

      revoke(originalUrl); revoke(masterUrl); revoke(previewUrl);
      originalUrl=null; masterUrl=null; previewUrl=null;

      document.querySelectorAll(".pTime[data-k='cur']").forEach(el => el.textContent="0:00");
      document.querySelectorAll(".pTime[data-k='dur']").forEach(el => el.textContent="0:00");
      document.querySelectorAll(".pSeek").forEach(el => el.value="0");
      document.querySelectorAll(".pBtn[data-act='play']").forEach(el => el.textContent="▶");
    }

    document.getElementById("btnReset").onclick = () => {
      resetResult();
      document.getElementById("file").value = "";
      document.getElementById("fileName").textContent = "Sin archivo";
      setStatus("Listo.", 0);
    };

    // ========= MODAL =========
    const modalBack = document.getElementById("modalBack");
    const payMsg = document.getElementById("payMsg");

    function openModal(msg){
      payMsg.textContent = msg || "";
      modalBack.style.display = "flex";
    }
    function closeModal(){
      modalBack.style.display = "none";
      payMsg.textContent = "";
    }
    document.getElementById("closeModal").onclick = closeModal;
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(); });

    document.getElementById("btnUnlock").onclick = () => openModal("");

    async function postJSON(path, body){
      const res = await fetchWithTimeout((API_BASE||"") + path, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body||{})
      }, 180000);
      return res;
    }

    function afterUnlockUI(){
      const fullBtn = document.getElementById("btnDownloadFull");
      const upBtn = document.getElementById("btnUpgradeToPro");

      if (paidQuality === "PLUS") {
        fullBtn.style.display = "";
        upBtn.style.display = "";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Master desbloqueado. Disponible en dashboard para re-descarga.`;
        return;
      }
      if (paidQuality === "PRO") {
        fullBtn.style.display = "";
        upBtn.style.display = "none";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge pro">◆ PRO</span> Master desbloqueado. Disponible en dashboard para re-descarga.`;
        return;
      }
      if (currentPlan === "PLUS") {
        fullBtn.style.display = "";
        upBtn.style.display = "";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Descarga completa habilitada por plan.`;
        return;
      }
      if (currentPlan === "PRO") {
        fullBtn.style.display = "";
        upBtn.style.display = "none";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge pro">◆ PRO</span> Descarga completa habilitada por plan.`;
        return;
      }

      fullBtn.style.display = "none";
      upBtn.style.display = "none";
      document.getElementById("unlockHint").innerHTML =
        `<span class="badge free">■ FREE</span> Escucha completo. Descarga: 20s.`;
    }

    async function unlock(quality){
      if(!lastMasterId){
        openModal("Primero procesa un master.");
        return;
      }
      payMsg.textContent = "Procesando unlock...";
      try{
        const res = await postJSON("/api/unlock", { master_id:lastMasterId, quality });
        if(!res.ok) throw new Error("unlock fail");
        const data = await res.json();
        paidQuality = (data.quality || quality).toUpperCase();
        closeModal();
        afterUnlockUI();
      }catch(e){
        payMsg.textContent = "Falta backend /api/unlock (lo agregamos en backend).";
      }
    }

    async function upgradeToPro(){
      if(!lastMasterId){
        alert("Primero procesa un master.");
        return;
      }
      try{
        const res = await postJSON("/api/upgrade", { master_id:lastMasterId, from:"PLUS", to:"PRO" });
        if(!res.ok) throw new Error("upgrade fail");
        await res.json();
        paidQuality = "PRO";
        afterUnlockUI();
      }catch(e){
        alert("Upgrade requiere /api/upgrade (lo agregamos en backend).");
      }
    }

    document.getElementById("buyPlus").onclick = () => unlock("PLUS");
    document.getElementById("buyPro").onclick  = () => unlock("PRO");
    document.getElementById("btnUpgradeToPro").onclick = upgradeToPro;

    // ========= DOWNLOAD =========
    function downloadBlobUrl(url, filename){
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    document.getElementById("btnDownloadPreview").onclick = async () => {
      if(!lastMasterId){
        alert("Primero procesa un master.");
        return;
      }
      try{
        setStatus("Generando preview...", 70);
        const res = await fetchWithTimeout((API_BASE||"") + `/api/master/preview?master_id=${encodeURIComponent(lastMasterId)}`, {}, 180000);
        if(!res.ok) throw new Error("preview fail");
        const blob = await res.blob();
        revoke(previewUrl);
        previewUrl = URL.createObjectURL(blob);
        downloadBlobUrl(previewUrl, "warmaster_preview_20s.wav");
        setStatus("Listo.", 100);
      }catch(e){
        alert("Preview 20s requiere /api/master/preview (lo agregamos en backend).");
        setStatus("Listo.", 100);
      }
    };

    document.getElementById("btnDownloadFull").onclick = async () => {
      if(!lastMasterId){
        alert("Primero procesa un master.");
        return;
      }
      const url = (API_BASE||"") + `/api/masters/${encodeURIComponent(lastMasterId)}/download`;
      window.open(url, "_blank");
    };

    // ========= File picker UX =========
    const fileInput = document.getElementById("file");
    const btnPickFile = document.getElementById("btnPickFile");
    const fileNameEl = document.getElementById("fileName");

    btnPickFile.onclick = () => fileInput.click();
    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0];
      fileNameEl.textContent = f ? f.name : "Sin archivo";
    });

    // ========= Player custom =========
    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec || 0));
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function bindPlayer(containerId, audioId){
      const box = document.getElementById(containerId);
      const audio = document.getElementById(audioId);
      if(!box || !audio) return;

      const btn = box.querySelector('[data-act="play"]');
      const seek = box.querySelector('[data-act="seek"]');
      const vol  = box.querySelector('[data-act="vol"]');
      const cur  = box.querySelector('[data-k="cur"]');
      const dur  = box.querySelector('[data-k="dur"]');

      let dragging = false;

      function syncBtn(){
        btn.textContent = audio.paused ? "▶" : "II";
      }

      audio.addEventListener("loadedmetadata", () => {
        dur.textContent = fmtTime(audio.duration);
        cur.textContent = "0:00";
        seek.value = "0";
      });

      audio.addEventListener("timeupdate", () => {
        if(dragging) return;
        cur.textContent = fmtTime(audio.currentTime);
        const p = audio.duration ? (audio.currentTime / audio.duration) : 0;
        seek.value = String(Math.round(p * 1000));
      });

      audio.addEventListener("play", syncBtn);
      audio.addEventListener("pause", syncBtn);
      audio.addEventListener("ended", () => { audio.currentTime = 0; audio.pause(); });

      btn.addEventListener("click", () => {
        document.querySelectorAll("audio").forEach(a => { if(a !== audio) a.pause(); });
        if(audio.paused) audio.play(); else audio.pause();
      });

      seek.addEventListener("input", () => { dragging = true; });
      seek.addEventListener("change", () => {
        dragging = false;
        const p = Number(seek.value) / 1000;
        if(audio.duration) audio.currentTime = p * audio.duration;
      });

      vol.addEventListener("input", () => { audio.volume = Number(vol.value); });
      audio.volume = Number(vol.value);
      syncBtn();
    }

    bindPlayer("playerOriginal", "audioOriginal");
    bindPlayer("playerMaster", "audioMaster");

    // ========= PROCESS =========
    document.getElementById("btnMaster").onclick = async () => {
      const file = fileInput.files?.[0];
      if(!file){ alert("Selecciona un archivo."); return; }

      resetResult();
      setStatus("Subiendo...", 10);

      revoke(originalUrl);
      originalUrl = URL.createObjectURL(file);
      const ao = document.getElementById("audioOriginal");
      ao.src = originalUrl; ao.load();

      const form = new FormData();
      form.append("file", file);
      form.append("preset", selectedTarget);
      form.append("intensity", String(selectedIntensity));

      // ===== enviar knobs al backend (para que el archivo final descargado sea igual a lo escuchado) =====
      const K = window.WM_KNOBS || { low:0, mid:0, pres:0, air:0, glue:0, width:100, sat:0, out:0 };
      form.append("k_low",   String(K.low));
      form.append("k_mid",   String(K.mid));
      form.append("k_pres",  String(K.pres));
      form.append("k_air",   String(K.air));
      form.append("k_glue",  String(K.glue));
      form.append("k_width", String(K.width));
      form.append("k_sat",   String(K.sat));
      form.append("k_out",   String(K.out));

      // (compat)
      form.append("requested_quality", currentPlan);
      form.append("target", selectedTarget);

      try{
        setStatus("Procesando...", 40);

        const res = await fetchWithTimeout((API_BASE||"") + "/api/master", {
          method:"POST",
          body: form
        }, 180000);

        if(!res.ok){
          const txt = await res.text().catch(()=>"(sin detalle)");
          throw new Error(txt);
        }

        const hdrId = res.headers.get("X-Master-Id") || res.headers.get("x-master-id");
        if(hdrId) lastMasterId = hdrId;

        const blob = await res.blob();
        setStatus("Finalizando...", 85);

        revoke(masterUrl);
        masterUrl = URL.createObjectURL(blob);
        const am = document.getElementById("audioMaster");
        am.src = masterUrl; am.load();

        document.getElementById("resultEmpty").style.display = "none";
        document.getElementById("resultBox").style.display = "";
        document.getElementById("resultPill").textContent = "Master listo";

        document.getElementById("backendNote").textContent = lastMasterId
          ? ("master_id: " + lastMasterId)
          : "Falta header X-Master-Id en /api/master (lo añadimos en backend).";

        if(currentPlan === "PLUS" || currentPlan === "PRO"){
          paidQuality = currentPlan;
        } else {
          paidQuality = null;
        }
        afterUnlockUI();

        setStatus("Listo.", 100);
      }catch(err){
        console.error(err);
        setStatus("Error", 0);
        alert("Error al masterizar. " + (err?.message || ""));
      }
    };

    // ========= Init =========
    window.addEventListener("beforeunload", () => {
      revoke(originalUrl); revoke(masterUrl); revoke(previewUrl);
    });

    renderOptions();
    loadPlan();

    // ========= EQ LIVE (WebAudio real-time preview) =========
    (() => {
      const masterAudio = document.getElementById("audioMaster");
      const eqPanel = document.getElementById("eqPanel");
      if (!masterAudio || !eqPanel) return;

      // dB knobs + macros (%)
      const state = {
        low:0, mid:0, pres:0, air:0,
        glue:0,      // 0..100 %
        width:100,   // 50..150 %
        sat:0,       // 0..100 %
        out:0
      };

      // Exponer para el submit (backend)
      window.WM_KNOBS = state;

      let ctx=null, src=null, analyser=null, rafId=0;

      // core nodes
      let lowShelf=null, midPeak=null, presPeak=null, highShelf=null;
      let glueComp=null;

      // saturation nodes (dry/wet)
      let satShaper=null, satDry=null, satWet=null, satMix=null;

      // width (mid/side)
      let widthSplitter=null, widthMerger=null;
      let midSum=null, sideSum=null, sideScale=null;
      let leftOut=null, rightOut=null;

      // output / limiter
      let outGain=null, limiter=null;

      const canvas = document.getElementById("eqViz");
      const g = canvas ? canvas.getContext("2d") : null;
      const buf = new Uint8Array(1024);

      function dbToGain(db){ return Math.pow(10, db/20); }
      function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

      function makeWaveshaperCurve(drive){
        // drive: 0..1
        const n = 2048;
        const curve = new Float32Array(n);
        const k = 1 + drive * 40; // 1..41
        for(let i=0;i<n;i++){
          const x = (i * 2 / (n-1)) - 1;
          curve[i] = Math.tanh(k * x) / Math.tanh(k);
        }
        return curve;
      }

      function ensureAudioGraph(){
        if (ctx) return;

        ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === "suspended") ctx.resume().catch(()=>{});

        src = ctx.createMediaElementSource(masterAudio);

        // EQ
        lowShelf = ctx.createBiquadFilter();
        lowShelf.type = "lowshelf";
        lowShelf.frequency.value = 120;

        midPeak = ctx.createBiquadFilter();
        midPeak.type = "peaking";
        midPeak.frequency.value = 630;
        midPeak.Q.value = 1.0;

        presPeak = ctx.createBiquadFilter();
        presPeak.type = "peaking";
        presPeak.frequency.value = 1760;
        presPeak.Q.value = 1.0;

        highShelf = ctx.createBiquadFilter();
        highShelf.type = "highshelf";
        highShelf.frequency.value = 8500;

        // Glue compressor
        glueComp = ctx.createDynamicsCompressor();
        glueComp.knee.value = 18;
        glueComp.attack.value = 0.01;
        glueComp.release.value = 0.18;

        // Saturation (dry/wet)
        satDry = ctx.createGain();
        satWet = ctx.createGain();
        satMix = ctx.createGain(); // sum point

        satShaper = ctx.createWaveShaper();
        satShaper.oversample = "4x";

        // Width M/S
        widthSplitter = ctx.createChannelSplitter(2);
        widthMerger = ctx.createChannelMerger(2);

        // mid/side sums
        const lToMid = ctx.createGain(); lToMid.gain.value = 0.5;
        const rToMid = ctx.createGain(); rToMid.gain.value = 0.5;

        const lToSide = ctx.createGain(); lToSide.gain.value = 0.5;
        const rToSide = ctx.createGain(); rToSide.gain.value = -0.5;

        midSum = ctx.createGain();   // receives L+R
        sideSum = ctx.createGain();  // receives L-R

        sideScale = ctx.createGain(); // width control

        leftOut = ctx.createGain();  // mid + side
        rightOut = ctx.createGain(); // mid - side

        const invSide = ctx.createGain(); invSide.gain.value = -1; // for right channel

        // Output chain
        outGain = ctx.createGain();
        limiter = ctx.createDynamicsCompressor();
        limiter.threshold.value = -1.0;
        limiter.knee.value = 0.0;
        limiter.ratio.value = 20.0;
        limiter.attack.value = 0.003;
        limiter.release.value = 0.09;

        analyser = ctx.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.85;

        // Wiring:
        src
          .connect(lowShelf)
          .connect(midPeak)
          .connect(presPeak)
          .connect(highShelf)
          .connect(glueComp);

        // saturation split
        glueComp.connect(satDry);
        glueComp.connect(satShaper);
        satShaper.connect(satWet);

        // mix sum
        satDry.connect(satMix);
        satWet.connect(satMix);

        // width
        satMix.connect(widthSplitter);

        // build mid
        widthSplitter.connect(lToMid, 0);
        widthSplitter.connect(rToMid, 1);
        lToMid.connect(midSum);
        rToMid.connect(midSum);

        // build side
        widthSplitter.connect(lToSide, 0);
        widthSplitter.connect(rToSide, 1);
        lToSide.connect(sideSum);
        rToSide.connect(sideSum);

        // width scaling
        sideSum.connect(sideScale);

        // L = mid + side
        midSum.connect(leftOut);
        sideScale.connect(leftOut);

        // R = mid - side
        midSum.connect(rightOut);
        sideScale.connect(invSide);
        invSide.connect(rightOut);

        // to stereo
        leftOut.connect(widthMerger, 0, 0);
        rightOut.connect(widthMerger, 0, 1);

        // to output
        widthMerger
          .connect(outGain)
          .connect(limiter)
          .connect(analyser)
          .connect(ctx.destination);

        applyParams(true);
        startViz();
      }

      function applyParams(instant=false){
        if (!ctx) return;
        const t = ctx.currentTime;
        const k = instant ? 0.001 : 0.06;

        // EQ dB
        lowShelf.gain.setTargetAtTime(state.low, t, k);
        midPeak.gain.setTargetAtTime(state.mid, t, k);
        presPeak.gain.setTargetAtTime(state.pres, t, k);
        highShelf.gain.setTargetAtTime(state.air, t, k);

        // GLUE 0..100 -> threshold/ratio/makeup (soft)
        const gP = clamp(state.glue / 100, 0, 1);
        const thr = -10 - gP * 18;      // -10 .. -28 dB
        const rat = 1.5 + gP * 4.5;     // 1.5 .. 6.0
        const atk = 0.012 - gP * 0.007; // 12ms .. 5ms
        const rel = 0.20 + gP * 0.10;   // 200ms .. 300ms

        glueComp.threshold.setTargetAtTime(thr, t, k);
        glueComp.ratio.setTargetAtTime(rat, t, k);
        glueComp.attack.setTargetAtTime(atk, t, k);
        glueComp.release.setTargetAtTime(rel, t, k);

        // SAT 0..100 -> dry/wet + drive curve
        const sP = clamp(state.sat / 100, 0, 1);
        satShaper.curve = makeWaveshaperCurve(sP);
        satDry.gain.setTargetAtTime(1 - (sP * 0.55), t, k);
        satWet.gain.setTargetAtTime(sP * 0.85, t, k);

        // WIDTH 50..150 -> side gain 0.5..1.5
        const wP = clamp(state.width, 50, 150);
        const side = wP / 100; // 0.5..1.5
        sideScale.gain.setTargetAtTime(side, t, k);

        // OUTPUT dB
        outGain.gain.setTargetAtTime(dbToGain(state.out), t, k);
      }

      // ======= Knobs =======
      const knobEls = [...document.querySelectorAll(".knob")];
      const valEls = {
        low: document.getElementById("vLow"),
        mid: document.getElementById("vMid"),
        pres: document.getElementById("vPres"),
        air: document.getElementById("vAir"),
        glue: document.getElementById("vGlue"),
        width: document.getElementById("vWidth"),
        sat: document.getElementById("vSat"),
        out: document.getElementById("vOut"),
      };

      const ranges = {
        low:   {min:-12, max: 12, step:0.2, fmt:"db"},
        mid:   {min:-12, max: 12, step:0.2, fmt:"db"},
        pres:  {min:-12, max: 12, step:0.2, fmt:"db"},
        air:   {min:-12, max: 12, step:0.2, fmt:"db"},
        glue:  {min:  0, max:100, step:1,   fmt:"pct"},
        width: {min: 50, max:150, step:1,   fmt:"pct"},
        sat:   {min:  0, max:100, step:1,   fmt:"pct"},
        out:   {min:-12, max:  6, step:0.2, fmt:"db"},
      };

      function valueToAngle(v, key){
        const r = ranges[key];
        const p = (v - r.min) / (r.max - r.min);
        return (-120 + p * 240);
      }
      function angleToValue(a, key){
        const r = ranges[key];
        const p = (a + 120) / 240;
        return r.min + p * (r.max - r.min);
      }

      function setKnobUI(key){
        const el = knobEls.find(x => x.dataset.knob === key);
        if (!el) return;
        el.style.setProperty("--ang", valueToAngle(state[key], key) + "deg");

        const r = ranges[key];
        if (!valEls[key]) return;

        if (r.fmt === "db"){
          valEls[key].textContent = (state[key] >= 0 ? "+" : "") + state[key].toFixed(1) + " dB";
        } else {
          valEls[key].textContent = String(Math.round(state[key])) + "%";
        }
      }

      function initKnobs(){
        Object.keys(state).forEach(setKnobUI);

        knobEls.forEach(el => {
          const key = el.dataset.knob;
          let active = false;

          const onDown = (e) => {
            active = true;
            ensureAudioGraph();
            try { el.setPointerCapture(e.pointerId); } catch {}
          };

          const onMove = (e) => {
            if (!active) return;

            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width/2;
            const cy = rect.top + rect.height/2;

            const dx = e.clientX - cx;
            const dy = e.clientY - cy;

            let ang = Math.atan2(dy, dx) * (180/Math.PI);
            ang = ang - 90;
            while (ang < -180) ang += 360;
            while (ang > 180) ang -= 360;
            ang = clamp(ang, -120, 120);

            let v = angleToValue(ang, key);
            const r = ranges[key];
            v = clamp(v, r.min, r.max);
            v = Math.round(v / r.step) * r.step;

            state[key] = v;
            setKnobUI(key);

            // asegurar que el submit tenga los últimos valores
            window.WM_KNOBS = state;

            applyParams(false);
          };

          const onUp = () => { active = false; };

          el.addEventListener("pointerdown", onDown);
          window.addEventListener("pointermove", onMove);
          window.addEventListener("pointerup", onUp);
          window.addEventListener("pointercancel", onUp);
        });
      }

      // ======= Visual =======
      function drawGrid(){
        if (!g) return;
        const w = canvas.width, h = canvas.height;
        g.clearRect(0,0,w,h);

        g.fillStyle = "rgba(0,0,0,.18)";
        g.fillRect(0,0,w,h);

        g.strokeStyle = "rgba(255,255,255,.06)";
        g.lineWidth = 1;
        for(let x=0; x<=10; x++){
          const px = Math.round((x/10)*w);
          g.beginPath(); g.moveTo(px,0); g.lineTo(px,h); g.stroke();
        }
        for(let y=0; y<=6; y++){
          const py = Math.round((y/6)*h);
          g.beginPath(); g.moveTo(0,py); g.lineTo(w,py); g.stroke();
        }

        g.strokeStyle = "rgba(255,255,255,.10)";
        g.beginPath(); g.moveTo(0, h*0.5); g.lineTo(w, h*0.5); g.stroke();
      }

      function drawSpectrum(){
        if (!analyser || !g) return;
        analyser.getByteFrequencyData(buf);
        const w = canvas.width, h = canvas.height;

        g.beginPath();
        for(let i=0; i<buf.length; i++){
          const x = (i/(buf.length-1))*w;
          const v = buf[i]/255;
          const y = h - (v*v)*h*0.92;
          if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
        }
        g.lineTo(w,h); g.lineTo(0,h); g.closePath();

        const grad = g.createLinearGradient(0,0,0,h);
        grad.addColorStop(0, "rgba(109,94,252,.18)");
        grad.addColorStop(1, "rgba(45,212,191,.10)");
        g.fillStyle = grad;
        g.fill();

        g.strokeStyle = "rgba(255,255,255,.16)";
        g.lineWidth = 1.5;
        g.stroke();
      }

      function drawEQCurve(){
        if (!g) return;
        const w = canvas.width, h = canvas.height;

        function yFromDb(db){
          const maxDb = 12;
          const p = db / maxDb;
          return h*0.5 - p*(h*0.22);
        }

        const pts = [
          {x: w*0.12, y: yFromDb(state.low)},
          {x: w*0.35, y: yFromDb(state.mid)},
          {x: w*0.55, y: yFromDb(state.pres)},
          {x: w*0.78, y: yFromDb(state.air)}
        ];

        g.strokeStyle = "rgba(255,255,255,.90)";
        g.lineWidth = 2.2;
        g.beginPath();
        g.moveTo(0, h*0.5);

        for(let i=0; i<pts.length; i++){
          const p = pts[i];
          const prev = pts[i-1] || {x:0, y:h*0.5};
          const next = pts[i+1] || {x:w, y:h*0.5};

          const cp1x = prev.x + (p.x - prev.x)*0.55;
          const cp1y = prev.y + (p.y - prev.y)*0.55;
          const cp2x = p.x - (next.x - prev.x)*0.10;
          const cp2y = p.y;

          g.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p.x, p.y);
        }

        g.lineTo(w, h*0.5);
        g.stroke();

        g.fillStyle = "rgba(255,255,255,.95)";
        pts.forEach(p=>{
          g.beginPath();
          g.arc(p.x, p.y, 4.6, 0, Math.PI*2);
          g.fill();
        });
      }

      function startViz(){
        if (!g || !analyser) return;
        cancelAnimationFrame(rafId);
        const tick = () => {
          drawGrid();
          drawSpectrum();
          drawEQCurve();
          rafId = requestAnimationFrame(tick);
        };
        tick();
      }

      masterAudio.addEventListener("play", () => {
        ensureAudioGraph();
        if (ctx && ctx.state === "suspended") ctx.resume().catch(()=>{});
      }, {passive:true});

      initKnobs();
    })();
  </script>
</body>
</html>
