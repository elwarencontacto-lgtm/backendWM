<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WarMaster ‚Äî Masterizado</title>
<style>
:root{
  --bg0:#07080c; --bg1:#0b0e16; --text:#e9edf7; --muted: rgba(233,237,247,.72);
  --a:#8a5cff; --b:#00d7ff; --c:#00ff9a; --radius:22px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Arial,sans-serif; color:var(--text);
  background:
    radial-gradient(900px 500px at 10% 10%, rgba(138,92,255,.22), transparent 55%),
    radial-gradient(800px 500px at 90% 15%, rgba(0,215,255,.18), transparent 55%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
}
header{position:sticky; top:0; backdrop-filter:blur(14px); background:rgba(7,8,12,.55); border-bottom:1px solid rgba(255,255,255,.08);}
.wrap{width:min(1100px,calc(100% - 40px));margin:0 auto}
.nav{display:flex;justify-content:space-between;align-items:center;padding:16px 0;gap:12px;flex-wrap:wrap;}
.brand{font-size:20px;font-weight:900;text-decoration:none;color:var(--text);}
.grad{background:linear-gradient(90deg,var(--a),var(--b),var(--c));-webkit-background-clip:text;color:transparent;}
.btn{
  padding:10px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;font-weight:900;
  text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:10px;
}
.btn.primary{border:none;background:linear-gradient(90deg,var(--a),var(--b));color:#061018;}
.btn:disabled{opacity:.55;cursor:not-allowed}
main{padding:30px 0 80px}
.card{border-radius:var(--radius);border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);padding:20px;}
.field{margin-bottom:16px}
label{display:block;font-size:12px;font-weight:900;margin-bottom:6px;color:var(--muted);}
input[type="text"],select{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.3);color:var(--text);}
input[type="range"]{width:100%;accent-color:var(--b)}
.row{display:flex;justify-content:flex-end;gap:10px;margin-top:10px;flex-wrap:wrap;}
.hidden{display:none}
.progressWrap{margin-top:14px;display:none;gap:10px;align-items:center;}
.progressWrap.show{display:flex}
.progressBar{flex:1;height:10px;border-radius:10px;background:rgba(255,255,255,.08);overflow:hidden;}
.progressFill{height:100%;width:0%;background:linear-gradient(90deg,var(--a),var(--b));transition:width .25s ease;}
.progressText{min-width:92px;text-align:right;font-size:12px;color:rgba(233,237,247,.8);font-weight:900;}
.abSection{margin-top:20px;border-top:1px solid rgba(255,255,255,.10);padding-top:16px;}
.abBtns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
audio{width:100%;margin-top:6px}
.note{font-size:12px;color:rgba(233,237,247,.65);margin-top:10px;line-height:1.5}
.statusBox{
  margin-top:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);padding:10px 12px;font-size:12px;line-height:1.5;color:rgba(233,237,247,.82);
  word-break:break-word;
}
.statusBox b{color:rgba(233,237,247,.95)}
</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="nav">
      <a class="brand" href="index.html">War<span class="grad">Master</span></a>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <a class="btn" href="dashboard.html">Dashboard</a>
        <a class="btn" href="index.html">Landing</a>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <h1 style="margin:0 0 14px;">Masterizado</h1>

    <section class="card">

      <div class="field">
        <label>Archivo</label>
        <input type="text" id="fileName" readonly placeholder="Selecciona un archivo"/>
        <div class="row" style="justify-content:flex-start;">
          <button class="btn" id="btnPick" type="button">Seleccionar</button>
        </div>
        <input type="file" id="fileInput" accept="audio/*" hidden/>
        <div class="note">Renderiza en el backend de Render.</div>
      </div>

      <div class="field">
        <label>Preset</label>
        <select id="preset">
          <option value="clean">Clean</option>
          <option value="club">Club</option>
          <option value="warm">Warm</option>
          <option value="bright">Bright</option>
          <option value="heavy">Heavy</option>
        </select>
      </div>

      <div class="field">
        <label>Intensidad</label>
        <input type="range" id="intensity" min="0" max="100" value="55"/>
      </div>

      <div class="progressWrap" id="progressWrap" aria-live="polite">
        <div class="progressBar"><div class="progressFill" id="progressFill"></div></div>
        <div class="progressText" id="progressText">0%</div>
      </div>

      <div class="row">
        <button class="btn primary" id="btnRender" type="button" disabled>Renderizar</button>
      </div>

      <div class="statusBox" id="statusBox">
        <b>Estado:</b> Esperando archivo‚Ä¶
      </div>

      <div class="abSection hidden" id="abSection">
        <h3 style="margin:0 0 10px;">Escucha A/B</h3>

        <div class="abBtns">
          <button class="btn" id="btnOriginal" type="button">Original</button>
          <button class="btn" id="btnMaster" type="button" disabled>Master</button>
          <a class="btn primary" id="btnDownload" href="#" download="warmaster_master.wav" aria-disabled="true">Descargar</a>
        </div>

        <audio id="audioPlayer" controls></audio>
      </div>

    </section>
  </div>
</main>

<script>
  const fileInput = document.getElementById("fileInput");
  const btnPick   = document.getElementById("btnPick");
  const fileName  = document.getElementById("fileName");
  const btnRender = document.getElementById("btnRender");
  const preset    = document.getElementById("preset");
  const intensity = document.getElementById("intensity");

  const progressWrap = document.getElementById("progressWrap");
  const progressFill = document.getElementById("progressFill");
  const progressText = document.getElementById("progressText");

  const statusBox = document.getElementById("statusBox");

  const abSection   = document.getElementById("abSection");
  const audioPlayer = document.getElementById("audioPlayer");
  const btnOriginal = document.getElementById("btnOriginal");
  const btnMaster   = document.getElementById("btnMaster");
  const btnDownload = document.getElementById("btnDownload");

  let currentFile = null;
  let originalURL = null;
  let masterURL   = null;

  function setStatus(msg){
    statusBox.innerHTML = "<b>Estado:</b> " + msg;
  }

  function setProgress(pct, label){
    const v = Math.max(0, Math.min(100, pct|0));
    progressWrap.classList.add("show");
    progressFill.style.width = v + "%";
    progressText.textContent = (label ? label : (v + "%"));
  }
  function hideProgressSoon(){
    setTimeout(()=> progressWrap.classList.remove("show"), 900);
  }

  function getApiBase(){
    const qs = new URLSearchParams(location.search);
    const fromQS = (qs.get("api") || "").trim();
    if (fromQS) return fromQS.replace(/\/+$/, "");
    return "https://backendwm.onrender.com";
  }
  const API_BASE = getApiBase();

  async function fetchWithTimeout(url, options, timeoutMs){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), timeoutMs);
    try{
      return await fetch(url, { ...options, signal: controller.signal, mode:"cors" });
    } finally {
      clearTimeout(t);
    }
  }

  // DEBUG: confirma que JS carg√≥
  console.log("[WarMaster] JS loaded. API_BASE:", API_BASE);
  setStatus(`Listo. API: <span style="color:rgba(0,215,255,.95)">${API_BASE}</span>`);

  btnPick.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", (e) => {
    currentFile = e.target.files && e.target.files[0] ? e.target.files[0] : null;
    if (!currentFile){
      setStatus("No se seleccion√≥ archivo.");
      btnRender.disabled = true;
      return;
    }

    fileName.value = currentFile.name;
    btnRender.disabled = false;

    if (originalURL) { URL.revokeObjectURL(originalURL); originalURL = null; }
    if (masterURL)   { URL.revokeObjectURL(masterURL);   masterURL   = null; }

    originalURL = URL.createObjectURL(currentFile);
    audioPlayer.src = originalURL;

    abSection.classList.remove("hidden");
    btnMaster.disabled = true;

    btnDownload.href = "#";
    btnDownload.setAttribute("aria-disabled", "true");

    setStatus(`Archivo cargado: <span style="color:rgba(0,255,154,.9)">${currentFile.name}</span> (${Math.round(currentFile.size/1024/1024)} MB).`);
    setProgress(0, "Listo");
    hideProgressSoon();
  });

  btnRender.addEventListener("click", async () => {
    // üî• Si esto no cambia, el click no est√° llegando
    console.log("[WarMaster] Render click", { hasFile: !!currentFile });

    if (!currentFile){
      setStatus("‚ùå No hay archivo seleccionado.");
      return;
    }

    btnRender.disabled = true;
    btnRender.textContent = "Procesando‚Ä¶";
    setProgress(10, "Subiendo‚Ä¶");
    setStatus("Enviando audio al servidor‚Ä¶");

    try{
      // chequeo salud primero (para detectar problema de conexi√≥n)
      const health = await fetchWithTimeout(API_BASE + "/api/health", { method:"GET" }, 15000);
      if (!health.ok){
        setStatus(`‚ùå API no responde bien. /api/health status ${health.status}`);
        alert("La API no respondi√≥ correctamente. Revisa Render.");
        return;
      }

      const fd = new FormData();
      fd.append("file", currentFile);
      fd.append("preset", preset.value);
      fd.append("intensity", intensity.value);

      const url = API_BASE.replace(/\/+$/, "") + "/api/master";
      console.log("[WarMaster] POST", url);

      setProgress(25, "Enviando‚Ä¶");

      const res = await fetchWithTimeout(url, { method: "POST", body: fd }, 180000);

      setProgress(70, "Procesando‚Ä¶");

      const ct = (res.headers.get("content-type") || "").toLowerCase();

      if (!res.ok){
        const txt = await res.text().catch(()=> "");
        setStatus(`‚ùå Error backend (${res.status}).`);
        alert(`Render fall√≥ (${res.status}).\n${txt.slice(0,700)}`);
        return;
      }

      if (ct.includes("application/json")){
        const txt = await res.text().catch(()=> "");
        setStatus("‚ùå Backend devolvi√≥ JSON (error).");
        alert("El backend devolvi√≥ JSON (no audio).\n" + txt.slice(0,700));
        return;
      }

      const blob = await res.blob();
      if (!blob || blob.size < 1024){
        setStatus("‚ùå El master lleg√≥ vac√≠o.");
        alert("El master lleg√≥ vac√≠o o muy peque√±o.");
        return;
      }

      if (masterURL) { URL.revokeObjectURL(masterURL); masterURL = null; }
      masterURL = URL.createObjectURL(blob);

      btnMaster.disabled = false;
      btnDownload.href = masterURL;
      btnDownload.setAttribute("aria-disabled", "false");

      setProgress(100, "Listo ‚úÖ");
      setStatus("‚úÖ Master generado. Puedes escuchar y descargar.");
      console.log("[WarMaster] OK blob bytes:", blob.size);

    } catch (err) {
      console.error("[WarMaster] fetch error:", err);
      setStatus("‚ùå Error de red. El navegador no logr√≥ conectarse al servidor.");
      const msg =
        (err && err.name === "AbortError")
          ? "Tiempo de espera agotado (15s salud / 3 min render)."
          : "Error de red/JS: Failed to fetch.\n\n‚úÖ Aseg√∫rate de abrir master.html desde https://backendwm.onrender.com (no local) y que Render est√© en RUNNING.";

      alert(msg);

    } finally {
      btnRender.disabled = !currentFile;
      btnRender.textContent = "Renderizar";
      hideProgressSoon();
    }
  });

  btnOriginal.addEventListener("click", () => {
    if (originalURL) audioPlayer.src = originalURL;
  });

  btnMaster.addEventListener("click", () => {
    if (masterURL) audioPlayer.src = masterURL;
  });
</script>

</body>
</html>
