<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WarMaster | Master</title>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --panel2:#0f1117;
      --line:#232736;
      --text:#e9ecf3;
      --muted:#a8b0c3;

      /* Brand base */
      --brand:#6d5efc;
      --brand2:#2dd4bf;

      /* Plan colors (official) */
      --free:#ffffff;   /* FREE blanco */
      --plus:#f5c542;   /* PLUS amarillo premium */
      --pro:#4ea8ff;    /* PRO azul premium */

      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#22c55e;

      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(109,94,252,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), #06070a 70%);
      color:var(--text);
      min-height:100vh;
      padding:18px;
    }

    .wrap{width:min(1120px,100%); margin:0 auto}
    a{color:inherit}

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.3px;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 0 0 6px rgba(109,94,252,.12);
    }
    .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .pill{
      font-size:12px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }

    /* Plan pill */
    .planPill{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--free);
      font-weight:900;
    }
    .planPill.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
    .planPill.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }
    .planPill.free{ color: var(--free); border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.03); }

    /* Card + optional plan glow */
    .card{
      background: rgba(18,20,27,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardGlowPlus{ box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(245,197,66,.18), 0 0 24px rgba(245,197,66,.10); }
    .cardGlowPro{  box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 0 1px rgba(78,168,255,.18), 0 0 24px rgba(78,168,255,.10); }

    .head{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .head h2{margin:0; font-size:16px}

    .body{padding:16px 18px}
    .muted{color:var(--muted)}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:900;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.06)}
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Plan buttons accents */
    .btnPlus{
      border-color: rgba(245,197,66,.45);
      background: rgba(245,197,66,.10);
      color: var(--plus);
    }
    .btnPro{
      border-color: rgba(78,168,255,.45);
      background: rgba(78,168,255,.10);
      color: var(--pro);
    }

    .btnPrimary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
      color: #fff;
    }
    .btnPrimary:hover{filter:brightness(1.06)}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .input{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .selectGrid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    @media (max-width: 520px){ .selectGrid{grid-template-columns:1fr} }

    .opt{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
      position:relative;
    }
    .opt:hover{background: rgba(255,255,255,.05)}
    .opt:active{transform: translateY(1px)}
    .opt b{display:block; margin-bottom:6px}
    .opt small{color:var(--muted)}
    .opt.active{
      border-color: rgba(109,94,252,.65);
      background: rgba(109,94,252,.10);
    }

    /* Lock badge (no emojis) */
    .lock{
      position:absolute; top:10px; right:10px;
      font-size:12px;
      border:1px solid rgba(245,197,66,.35);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(245,197,66,.08);
      color: var(--plus);
      font-weight:900;
    }

    .bar{
      width:100%;
      height:10px;
      border:1px solid var(--line);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
    }

    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.5;
    }

    audio{width:100%}
    .divider{border:none;border-top:1px solid var(--line); margin:14px 0}

    .badge{
      font-weight:900;
      font-size:12px;
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--free);
      margin-right:8px;
    }
    .badge.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
    .badge.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }
    .badge.free{ color: var(--free); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.03); }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.6);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(560px, 100%);
      background: rgba(18,20,27,.98);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .body{padding:16px 18px}
    .priceBtn{ width:100%; justify-content:center; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span> WarMaster</div>
      <div class="nav">
        <span class="pill" id="apiPill">API: auto</span>
        <span class="pill planPill free" id="planPill">■ FREE</span>
        <button class="btn" id="goHome">Inicio</button>
        <button class="btn" id="goDash">Dashboard</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card" id="cardLeft">
        <div class="head">
          <h2>Nuevo Master</h2>
          <span class="pill" id="statusPill">Listo</span>
        </div>
        <div class="body">
          <label>Archivo (mp3/wav)</label>
          <input class="input" type="file" id="file" accept="audio/*"/>

          <div style="height:12px"></div>

          <label>Destino / Preset</label>
          <div class="selectGrid" id="targets"></div>

          <div style="height:12px"></div>

          <label>Intensidad</label>
          <div class="selectGrid" id="intensity"></div>

          <div class="note" id="planNote">
            <span class="badge free">■ FREE</span>
            Escucha el master completo. Descarga: 20s.
          </div>

          <hr class="divider"/>

          <div class="row">
            <button class="btn btnPrimary" id="btnMaster">Procesar</button>
            <button class="btn" id="btnReset">Limpiar</button>
          </div>

          <div style="height:12px"></div>
          <div class="bar" aria-label="progreso"><div id="barFill"></div></div>
          <div class="note" id="status">Listo.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="cardRight">
        <div class="head">
          <h2>Resultado</h2>
          <span class="pill" id="resultPill">—</span>
        </div>
        <div class="body">
          <div id="resultEmpty" class="muted">Sube un archivo y presiona “Procesar”.</div>

          <div id="resultBox" style="display:none">
            <label>Original</label>
            <audio id="audioOriginal" controls></audio>

            <div style="height:10px"></div>

            <label>Master</label>
            <audio id="audioMaster" controls></audio>

            <div class="note" id="unlockHint"></div>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="btnDownloadPreview">Descargar 20s</button>
              <button class="btn btnPlus" id="btnUnlock">◇ Desbloquear</button>
              <button class="btn btnPro" id="btnUpgradeToPro" style="display:none">◆ Upgrade PRO</button>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn btnPrimary" id="btnDownloadFull" style="display:none">Descargar completo</button>
            </div>

            <div class="note" id="backendNote"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal unlock -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="head">
        <h2>Desbloquear descarga</h2>
        <button class="btn" id="closeModal">×</button>
      </div>
      <div class="body">
        <div class="note" style="margin-top:0" id="modalTopNote">
          Estás escuchando el master completo. Para descargar, elige:
        </div>

        <div style="height:12px"></div>

        <button class="btn btnPlus priceBtn" id="buyPlus">◇ Unlock PLUS (por canción)</button>
        <div class="note muted">Desbloquea este master y queda en tu dashboard.</div>

        <div style="height:10px"></div>

        <button class="btn btnPro priceBtn" id="buyPro">◆ Unlock PRO (por canción)</button>
        <div class="note muted">Versión PRO del master (según motor backend).</div>

        <hr class="divider"/>

        <div class="note" id="payMsg"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= API BASE =========
    function getApiBase() {
      const qs = new URLSearchParams(location.search);
      const fromQS = qs.get("api");
      if (fromQS) return fromQS.replace(/\/+$/,'');
      const stored = localStorage.getItem("WM_API_BASE");
      if (stored) return stored.replace(/\/+$/,'');
      return ""; // same origin
    }
    const API_BASE = getApiBase();
    document.getElementById("apiPill").textContent = "API: " + (API_BASE || "mismo dominio");

    function qsCarry(path){
      const qs = new URLSearchParams(location.search);
      const api = qs.get("api");
      return api ? (path + "?api=" + encodeURIComponent(api)) : path;
    }
    document.getElementById("goHome").onclick = () => location.href = qsCarry("/index.html");
    document.getElementById("goDash").onclick = () => location.href = qsCarry("/dashboard.html");

    async function fetchWithTimeout(url, options={}, timeoutMs=180000) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), timeoutMs);
      try { return await fetch(url, { ...options, signal: ctrl.signal }); }
      finally { clearTimeout(id); }
    }

    // ========= PLAN STATE (dynamic) =========
    let currentPlan = "FREE"; // FREE / PLUS / PRO
    function applyPlanUI(){
      const pill = document.getElementById("planPill");
      pill.classList.remove("free","plus","pro");
      const left = document.getElementById("cardLeft");
      const right = document.getElementById("cardRight");
      left.classList.remove("cardGlowPlus","cardGlowPro");
      right.classList.remove("cardGlowPlus","cardGlowPro");

      if(currentPlan === "PLUS"){
        pill.textContent = "◇ PLUS";
        pill.classList.add("plus");
        left.classList.add("cardGlowPlus");
        right.classList.add("cardGlowPlus");
        document.getElementById("planNote").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Descarga completa habilitada (plan).`;
      } else if(currentPlan === "PRO"){
        pill.textContent = "◆ PRO";
        pill.classList.add("pro");
        left.classList.add("cardGlowPro");
        right.classList.add("cardGlowPro");
        document.getElementById("planNote").innerHTML =
          `<span class="badge pro">◆ PRO</span> Descarga completa habilitada (plan).`;
      } else {
        pill.textContent = "■ FREE";
        pill.classList.add("free");
        document.getElementById("planNote").innerHTML =
          `<span class="badge free">■ FREE</span> Escucha completo. Descarga: 20s.`;
      }

      renderOptions(); // re-eval locks
    }

    async function loadPlan(){
      // En tu backend actual no existe /api/me: por eso, ahora quedará FREE.
      // En el siguiente paso (backend) lo añadimos para que funcione real.
      try{
        const res = await fetchWithTimeout((API_BASE||"") + "/api/me", {}, 12000);
        if(!res.ok) throw new Error("no /api/me");
        const data = await res.json();
        currentPlan = (data.plan || "FREE").toUpperCase();
        if(!["FREE","PLUS","PRO"].includes(currentPlan)) currentPlan="FREE";
      }catch(e){
        currentPlan = "FREE";
      }
      applyPlanUI();
    }

    // ========= OPTIONS =========
    // OJO: Tu backend hoy usa preset: clean/warm/bright/heavy/club.
    // Por eso aquí usamos esos mismos ids para que sea compatible.
    const TARGETS = [
      {id:"clean",  name:"Streaming", desc:"Balance general", lock:false},
      {id:"warm",   name:"Warm",      desc:"Cuerpo / suavidad", lock:false},
      {id:"bright", name:"Bright",    desc:"Brillo / presencia", lock:false},
      {id:"heavy",  name:"Heavy",     desc:"Grueso / denso", lock:false},
      {id:"club",   name:"Club",      desc:"Impacto alto", lock:true}, // lock en FREE (como negocio)
    ];

    const INTENSITIES = [
      {id:35, name:"Suave",      desc:"Más dinámico", lock:true},
      {id:55, name:"Balanceado", desc:"Default",      lock:false},
      {id:80, name:"Agresivo",   desc:"Más loud",     lock:true},
    ];

    let selectedTarget = "clean";
    let selectedIntensity = 55;

    function renderOptions(){
      const tBox = document.getElementById("targets");
      tBox.innerHTML = "";
      TARGETS.forEach(o=>{
        const div = document.createElement("div");
        const locked = o.lock && currentPlan === "FREE";
        div.className = "opt" + (o.id===selectedTarget ? " active" : "");
        div.innerHTML =
          `<b>${o.name}</b><small>${o.desc}</small>` +
          (locked ? `<span class="lock">◇ PLUS / ◆ PRO</span>` : "");
        div.onclick = () => {
          if (locked) { openModal("Este preset está disponible en PLUS/PRO o unlock por canción."); return; }
          selectedTarget = o.id;
          renderOptions();
        };
        tBox.appendChild(div);
      });

      const iBox = document.getElementById("intensity");
      iBox.innerHTML = "";
      INTENSITIES.forEach(o=>{
        const locked = o.lock && currentPlan === "FREE";
        const div = document.createElement("div");
        div.className = "opt" + (o.id===selectedIntensity ? " active" : "");
        div.innerHTML =
          `<b>${o.name}</b><small>${o.desc}</small>` +
          (locked ? `<span class="lock">◇ PLUS / ◆ PRO</span>` : "");
        div.onclick = () => {
          if (locked) { openModal("Esta intensidad está disponible en PLUS/PRO."); return; }
          selectedIntensity = o.id;
          renderOptions();
        };
        iBox.appendChild(div);
      });
    }

    // ========= RESULT STATE =========
    let lastMasterId = null;
    let masterUrl = null;
    let originalUrl = null;
    let previewUrl = null;

    let paidQuality = null; // null / PLUS / PRO (unlock)

    function revoke(url){ try{ if(url) URL.revokeObjectURL(url); }catch(e){} }

    function setStatus(msg, pct){
      document.getElementById("status").textContent = msg;
      document.getElementById("statusPill").textContent = msg.length > 18 ? "Procesando" : msg;
      const p = Math.max(0, Math.min(100, pct ?? 0));
      document.getElementById("barFill").style.width = p + "%";
    }

    function resetResult(){
      lastMasterId = null;
      paidQuality = null;

      document.getElementById("resultEmpty").style.display = "";
      document.getElementById("resultBox").style.display = "none";
      document.getElementById("resultPill").textContent = "—";
      document.getElementById("unlockHint").textContent = "";
      document.getElementById("backendNote").textContent = "";
      document.getElementById("btnDownloadFull").style.display = "none";
      document.getElementById("btnUpgradeToPro").style.display = "none";

      const ao = document.getElementById("audioOriginal");
      const am = document.getElementById("audioMaster");
      ao.removeAttribute("src"); am.removeAttribute("src");
      ao.load(); am.load();

      revoke(originalUrl); revoke(masterUrl); revoke(previewUrl);
      originalUrl=null; masterUrl=null; previewUrl=null;
    }

    document.getElementById("btnReset").onclick = () => {
      document.getElementById("file").value = "";
      resetResult();
      setStatus("Listo.", 0);
    };

    // ========= MODAL =========
    const modalBack = document.getElementById("modalBack");
    const payMsg = document.getElementById("payMsg");

    function openModal(msg){
      payMsg.textContent = msg || "";
      modalBack.style.display = "flex";
    }
    function closeModal(){
      modalBack.style.display = "none";
      payMsg.textContent = "";
    }
    document.getElementById("closeModal").onclick = closeModal;
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(); });

    document.getElementById("btnUnlock").onclick = () => openModal("");

    async function postJSON(path, body){
      const res = await fetchWithTimeout((API_BASE||"") + path, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body||{})
      }, 180000);
      return res;
    }

    function afterUnlockUI(){
      // Si plan es PLUS/PRO, ya hay descarga completa.
      // Si fue unlock individual, también.
      document.getElementById("btnDownloadFull").style.display = "";
      if (paidQuality === "PLUS") {
        document.getElementById("btnUpgradeToPro").style.display = "";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Master desbloqueado. Disponible en dashboard para re-descarga.`;
      } else if (paidQuality === "PRO") {
        document.getElementById("btnUpgradeToPro").style.display = "none";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge pro">◆ PRO</span> Master desbloqueado. Disponible en dashboard para re-descarga.`;
      } else if (currentPlan === "PLUS") {
        document.getElementById("btnUpgradeToPro").style.display = "";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge plus">◇ PLUS</span> Descarga completa habilitada por plan.`;
      } else if (currentPlan === "PRO") {
        document.getElementById("btnUpgradeToPro").style.display = "none";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge pro">◆ PRO</span> Descarga completa habilitada por plan.`;
      } else {
        document.getElementById("btnDownloadFull").style.display = "none";
        document.getElementById("btnUpgradeToPro").style.display = "none";
        document.getElementById("unlockHint").innerHTML =
          `<span class="badge free">■ FREE</span> Escucha completo. Descarga: 20s.`;
      }
    }

    async function unlock(quality){
      if(!lastMasterId){
        openModal("Primero procesa un master.");
        return;
      }
      payMsg.textContent = "Procesando unlock...";
      try{
        const res = await postJSON("/api/unlock", { master_id:lastMasterId, quality });
        if(!res.ok) throw new Error("unlock fail");
        const data = await res.json();
        paidQuality = (data.quality || quality).toUpperCase();
        closeModal();
        afterUnlockUI();
      }catch(e){
        payMsg.textContent =
          "Backend aún no tiene /api/unlock. En el siguiente paso lo añadimos para que el botón desbloquee la descarga.";
      }
    }

    async function upgradeToPro(){
      if(!lastMasterId){
        alert("Primero procesa un master.");
        return;
      }
      try{
        const res = await postJSON("/api/upgrade", { master_id:lastMasterId, from:"PLUS", to:"PRO" });
        if(!res.ok) throw new Error("upgrade fail");
        const data = await res.json();
        paidQuality = "PRO";
        afterUnlockUI();
      }catch(e){
        alert("Upgrade requiere endpoint /api/upgrade (lo añadimos en backend).");
      }
    }

    document.getElementById("buyPlus").onclick = () => unlock("PLUS");
    document.getElementById("buyPro").onclick  = () => unlock("PRO");
    document.getElementById("btnUpgradeToPro").onclick = upgradeToPro;

    // ========= DOWNLOAD =========
    function downloadBlobUrl(url, filename){
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    document.getElementById("btnDownloadPreview").onclick = async () => {
      if(!lastMasterId){
        alert("Primero procesa un master.");
        return;
      }
      try{
        setStatus("Generando preview...", 70);
        const res = await fetchWithTimeout((API_BASE||"") + `/api/master/preview?master_id=${encodeURIComponent(lastMasterId)}`, {}, 180000);
        if(!res.ok) throw new Error("preview fail");
        const blob = await res.blob();
        revoke(previewUrl);
        previewUrl = URL.createObjectURL(blob);
        downloadBlobUrl(previewUrl, "warmaster_preview_20s.mp3");
        setStatus("Listo.", 100);
      }catch(e){
        alert("Preview 20s requiere /api/master/preview (lo añadimos en backend).");
        setStatus("Listo.", 100);
      }
    };

    document.getElementById("btnDownloadFull").onclick = async () => {
      if(!lastMasterId){
        alert("Primero procesa un master.");
        return;
      }
      // Preferimos descarga desde backend (para respetar reglas paid)
      const url = (API_BASE||"") + `/api/masters/${encodeURIComponent(lastMasterId)}/download`;
      // Abrimos directo; si backend devuelve 402, el navegador lo mostrará como error.
      window.open(url, "_blank");
    };

    // ========= PROCESS =========
    document.getElementById("btnMaster").onclick = async () => {
      const file = document.getElementById("file").files?.[0];
      if(!file){ alert("Selecciona un archivo."); return; }

      resetResult();
      setStatus("Subiendo...", 10);

      revoke(originalUrl);
      originalUrl = URL.createObjectURL(file);
      const ao = document.getElementById("audioOriginal");
      ao.src = originalUrl; ao.load();

      // Tu backend actual usa preset + intensity
      const form = new FormData();
      form.append("file", file);
      form.append("preset", selectedTarget);
      form.append("intensity", String(selectedIntensity));

      // Extras (no rompen nada si backend los ignora)
      form.append("requested_quality", currentPlan);
      form.append("target", selectedTarget);

      try{
        setStatus("Procesando...", 40);

        const res = await fetchWithTimeout((API_BASE||"") + "/api/master", {
          method:"POST",
          body: form
        }, 180000);

        if(!res.ok){
          const txt = await res.text().catch(()=>"(sin detalle)");
          throw new Error(txt);
        }

        // master_id desde header (lo añadimos en backend en el paso 2)
        const hdrId = res.headers.get("X-Master-Id") || res.headers.get("x-master-id");
        if(hdrId) lastMasterId = hdrId;

        const blob = await res.blob();

        setStatus("Finalizando...", 85);

        revoke(masterUrl);
        masterUrl = URL.createObjectURL(blob);
        const am = document.getElementById("audioMaster");
        am.src = masterUrl; am.load();

        document.getElementById("resultEmpty").style.display = "none";
        document.getElementById("resultBox").style.display = "";
        document.getElementById("resultPill").textContent = "Master listo";

        // Si backend no dio id aún, avisamos (porque preview/download necesitan master_id real)
        document.getElementById("backendNote").textContent = lastMasterId
          ? ("master_id: " + lastMasterId)
          : "Falta header X-Master-Id en /api/master. En el siguiente paso lo añadimos al backend.";

        // Regla: si plan PLUS/PRO => descarga completa habilitada
        // Si FREE => solo 20s (hasta que haga unlock)
        if(currentPlan === "PLUS" || currentPlan === "PRO"){
          paidQuality = currentPlan;
        } else {
          paidQuality = null;
        }
        afterUnlockUI();

        setStatus("Listo.", 100);
      }catch(err){
        console.error(err);
        setStatus("Error", 0);
        alert("Error al masterizar. " + (err?.message || ""));
      }
    };

    // ========= Init =========
    window.addEventListener("beforeunload", () => {
      revoke(originalUrl); revoke(masterUrl); revoke(previewUrl);
    });

    renderOptions();
    loadPlan();
  </script>
</body>
</html>
