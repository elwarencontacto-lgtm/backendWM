<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WarMaster — Masterizado</title>

<style>
:root{
  --bg0:#07080c;
  --bg1:#0b0e16;
  --text:#e9edf7;
  --muted: rgba(233,237,247,.72);
  --a:#8a5cff;
  --b:#00d7ff;
  --c:#00ff9a;
  --radius:22px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial, sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 500px at 10% 10%, rgba(138,92,255,.22), transparent 55%),
    radial-gradient(800px 500px at 90% 15%, rgba(0,215,255,.18), transparent 55%),
    linear-gradient(180deg,var(--bg0),var(--bg1));
}
header{
  position:sticky;
  top:0;
  backdrop-filter:blur(14px);
  background:rgba(7,8,12,.55);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.wrap{width:min(1100px,calc(100% - 40px));margin:0 auto}
.nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:16px 0;
}
.brand{
  font-size:20px;
  font-weight:900;
  display:flex;
  align-items:center;
  gap:10px;
  text-decoration:none;
  color:var(--text);
}
.grad{
  background:linear-gradient(90deg,var(--a),var(--b),var(--c));
  -webkit-background-clip:text;
  color:transparent;
}
.btn{
  padding:10px 16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  cursor:pointer;
  font-weight:900;
}
.btn.primary{
  border:none;
  background:linear-gradient(90deg,var(--a),var(--b));
  color:#061018;
}
main{padding:30px 0 80px}
.card{
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  padding:20px;
}
.field{
  margin-bottom:16px;
}
label{
  display:block;
  font-size:12px;
  font-weight:900;
  margin-bottom:6px;
  color:var(--muted);
}
input[type="text"], select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.3);
  color:var(--text);
}
input[type="range"]{
  width:100%;
  accent-color:var(--b);
}
.row{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.hidden{display:none}
.progressBar{
  margin-top:14px;
  height:8px;
  border-radius:8px;
  background:rgba(255,255,255,.08);
  overflow:hidden;
}
.progressFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--a),var(--b));
  transition:width .3s ease;
}
.abSection{
  margin-top:20px;
}
audio{width:100%;margin-top:10px}
</style>
</head>

<body>
<header>
<div class="wrap">
<div class="nav">
<a class="brand" href="index.html">
War<span class="grad">Master</span>
</a>
<a class="btn" href="dashboard.html">Dashboard</a>
</div>
</div>
</header>

<main>
<div class="wrap">

<h1>Masterizado</h1>

<section class="card">

<div class="field">
<label>Archivo</label>
<input type="text" id="fileName" readonly placeholder="Selecciona un archivo"/>
<button class="btn" id="btnPick">Seleccionar</button>
<input type="file" id="fileInput" accept="audio/*" hidden/>
</div>

<div class="field">
<label>Preset</label>
<select id="preset">
<option value="clean">Clean</option>
<option value="club">Club</option>
<option value="warm">Warm</option>
<option value="bright">Bright</option>
<option value="heavy">Heavy</option>
</select>
</div>

<div class="field">
<label>Intensidad</label>
<input type="range" id="intensity" min="0" max="100" value="55"/>
</div>

<div class="progressBar hidden" id="progressBar">
<div class="progressFill" id="progressFill"></div>
</div>

<div class="row">
<button class="btn primary" id="btnRender" disabled>Renderizar</button>
</div>

<div class="abSection hidden" id="abSection">
<h3>Escucha A/B</h3>
<button class="btn" id="btnOriginal">Original</button>
<button class="btn" id="btnMaster" disabled>Master</button>
<a class="btn" id="btnDownload" download="warmaster_master.wav">Descargar</a>

<audio id="audioPlayer" controls></audio>
</div>

</section>

</div>
</main>

<script>
const fileInput=document.getElementById("fileInput");
const btnPick=document.getElementById("btnPick");
const fileName=document.getElementById("fileName");
const btnRender=document.getElementById("btnRender");
const preset=document.getElementById("preset");
const intensity=document.getElementById("intensity");
const progressBar=document.getElementById("progressBar");
const progressFill=document.getElementById("progressFill");
const abSection=document.getElementById("abSection");
const audioPlayer=document.getElementById("audioPlayer");
const btnOriginal=document.getElementById("btnOriginal");
const btnMaster=document.getElementById("btnMaster");
const btnDownload=document.getElementById("btnDownload");

let currentFile=null;
let originalURL=null;
let masterURL=null;

btnPick.onclick=()=>fileInput.click();

fileInput.onchange=(e)=>{
currentFile=e.target.files[0];
if(!currentFile)return;
fileName.value=currentFile.name;
btnRender.disabled=false;
originalURL=URL.createObjectURL(currentFile);
audioPlayer.src=originalURL;
abSection.classList.remove("hidden");
btnMaster.disabled=true;
};

function getApiBase(){
const qs=new URLSearchParams(location.search);
const fromQS=qs.get("api");
return fromQS?fromQS.replace(/\/+$/,""):location.origin.replace(/\/+$/,"");
}
const API_BASE=getApiBase();

async function fetchWithTimeout(url,options,timeout){
const controller=new AbortController();
const t=setTimeout(()=>controller.abort(),timeout);
try{return await fetch(url,{...options,signal:controller.signal});}
finally{clearTimeout(t);}
}

btnRender.onclick=async()=>{
if(!currentFile)return;

progressBar.classList.remove("hidden");
progressFill.style.width="20%";

btnRender.disabled=true;
btnRender.textContent="Procesando...";

try{
const fd=new FormData();
fd.append("file",currentFile);
fd.append("preset",preset.value);
fd.append("intensity",intensity.value);

const res=await fetchWithTimeout(
API_BASE+"/api/master",
{method:"POST",body:fd},
180000
);

progressFill.style.width="70%";

if(!res.ok){
const txt=await res.text();
alert("Error:\n"+txt);
return;
}

const blob=await res.blob();
if(blob.size<1024){
alert("Archivo master inválido.");
return;
}

if(masterURL)URL.revokeObjectURL(masterURL);
masterURL=URL.createObjectURL(blob);

btnMaster.disabled=false;
btnDownload.href=masterURL;
progressFill.style.width="100%";

}catch(err){
alert("Error de red/JS: "+err.message);
}finally{
btnRender.disabled=false;
btnRender.textContent="Renderizar";
setTimeout(()=>progressBar.classList.add("hidden"),1000);
}
};

btnOriginal.onclick=()=>audioPlayer.src=originalURL;
btnMaster.onclick=()=>audioPlayer.src=masterURL;
</script>

</body>
</html>
