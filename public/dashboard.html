<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WarMaster | Dashboard</title>

<style>
:root{
  --bg:#0b0c10;
  --line:#232736;
  --text:#e9ecf3;
  --muted:#a8b0c3;

  --brand:#6d5efc;
  --brand2:#2dd4bf;

  --free:#ffffff;
  --plus:#f5c542;
  --pro:#4ea8ff;

  --shadow: 0 10px 30px rgba(0,0,0,.45);
  --radius: 16px;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(1200px 600px at 15% 0%, rgba(109,94,252,.25), transparent 55%),
    radial-gradient(900px 600px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
    linear-gradient(180deg, var(--bg), #06070a 70%);
  color:var(--text);
  min-height:100vh;
  padding:18px;
}

.wrap{width:min(1120px,100%); margin:0 auto}

.top{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:14px;
}

.brand{
  display:flex; align-items:center; gap:10px;
  font-weight:900; letter-spacing:.3px;
}

.dot{
  width:12px;height:12px;border-radius:999px;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  box-shadow: 0 0 0 6px rgba(109,94,252,.12);
}

.nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

.pill{
  font-size:12px;
  padding:8px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  background: rgba(255,255,255,.03);
  color:var(--muted);
}

.planPill{
  font-weight:900;
}

.planPill.free{
  color: var(--free);
  border-color: rgba(255,255,255,.20);
}

.planPill.plus{
  color: var(--plus);
  border-color: rgba(245,197,66,.35);
  background: rgba(245,197,66,.08);
}

.planPill.pro{
  color: var(--pro);
  border-color: rgba(78,168,255,.35);
  background: rgba(78,168,255,.08);
}

.btn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color:var(--text);
  padding:10px 12px;
  border-radius: 12px;
  cursor:pointer;
  font-weight:900;
  transition: .15s ease;
  display:inline-flex; align-items:center;
}

.btn:hover{background: rgba(255,255,255,.06)}

.btnPrimary{
  border-color: transparent;
  background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
  color: #fff;
}

.card{
  background: rgba(18,20,27,.92);
  border:1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}

.head{
  padding:16px 18px;
  border-bottom:1px solid var(--line);
  background: rgba(255,255,255,.02);
  display:flex; justify-content:space-between;
}

.head h2{margin:0; font-size:16px}

.body{padding:16px 18px}

.grid{
  display:grid;
  gap:12px;
}

.empty{
  padding:18px;
  border:1px dashed rgba(255,255,255,.15);
  border-radius: 14px;
  color: var(--muted);
  background: rgba(255,255,255,.02);
}

.item{
  border:1px solid rgba(255,255,255,.06);
  border-radius: 14px;
  background: rgba(255,255,255,.02);
  padding:14px;
}

.title{
  font-weight:900;
}

.meta{
  color: var(--muted);
  font-size:12px;
  margin-top:6px;
}

.badge{
  font-weight:900;
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
}

.badge.plus{
  color: var(--plus);
  border-color: rgba(245,197,66,.35);
  background: rgba(245,197,66,.08);
}

.badge.pro{
  color: var(--pro);
  border-color: rgba(78,168,255,.35);
  background: rgba(78,168,255,.08);
}

/* Player */
.player{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  border-radius: 14px;
  margin-top:10px;
}

.pBtn{
  width:40px;height:40px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.15);
  color: var(--text);
  font-weight:900;
  cursor:pointer;
}

.pMid{flex:1}

.pTimeRow{
  display:flex;
  gap:8px;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

.pSeek{
  width:100%;
  accent-color: var(--brand);
}

.player audio{display:none}

.actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
</style>
</head>

<body>
<div class="wrap">

<div class="top">
  <div class="brand"><span class="dot"></span> WarMaster</div>
  <div class="nav">
    <span class="pill" id="apiPill">API</span>
    <span class="pill planPill free" id="planPill">FREE</span>
    <button class="btn" onclick="location.href='index.html'">Inicio</button>
    <button class="btn btnPrimary" onclick="location.href='master.html'">Nuevo Master</button>
  </div>
</div>

<div class="card">
  <div class="head">
    <h2>Masters Desbloqueados</h2>
    <span class="pill" id="countPill">0</span>
  </div>
  <div class="body">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none">
      No tienes masters desbloqueados todavía.
    </div>
  </div>
</div>

</div>

<script>
const API_BASE = "";
document.getElementById("apiPill").textContent = "API: mismo dominio";

async function loadPlan(){
  try{
    const r = await fetch("/api/me");
    const d = await r.json();
    const plan = (d.plan||"FREE").toUpperCase();
    const pill = document.getElementById("planPill");
    pill.classList.remove("free","plus","pro");
    pill.classList.add(plan.toLowerCase());
    pill.textContent = plan;
  }catch{}
}

function fmt(sec){
  sec=Math.floor(sec||0);
  const m=Math.floor(sec/60);
  const s=sec%60;
  return m+":"+String(s).padStart(2,"0");
}

function bindPlayer(box){
  const audio=box.querySelector("audio");
  const btn=box.querySelector(".pBtn");
  const seek=box.querySelector(".pSeek");
  const cur=box.querySelector(".cur");
  const dur=box.querySelector(".dur");

  audio.addEventListener("loadedmetadata",()=>{
    dur.textContent=fmt(audio.duration);
  });

  audio.addEventListener("timeupdate",()=>{
    cur.textContent=fmt(audio.currentTime);
    seek.value=(audio.currentTime/audio.duration)*1000||0;
  });

  btn.onclick=()=>{
    document.querySelectorAll("audio").forEach(a=>{if(a!==audio)a.pause();});
    audio.paused?audio.play():audio.pause();
    btn.textContent=audio.paused?"Play":"Pause";
  };

  seek.oninput=()=>{
    audio.currentTime=(seek.value/1000)*audio.duration;
  };
}

async function load(){
  const r=await fetch("/api/masters");
  if(!r.ok)return;
  const items=await r.json();
  const list=document.getElementById("list");
  const empty=document.getElementById("empty");
  document.getElementById("countPill").textContent=items.length;
  if(!items.length){empty.style.display="";return;}
  empty.style.display="none";

  items.forEach(it=>{
    const div=document.createElement("div");
    div.className="item";

    div.innerHTML=`
      <div class="title">${it.title||it.id}</div>
      <div class="meta">Preset: ${it.preset} · Intensidad: ${it.intensity}</div>
      <span class="badge ${it.quality.toLowerCase()}">${it.quality}</span>

      <div class="player">
        <button class="pBtn">Play</button>
        <div class="pMid">
          <div class="pTimeRow">
            <span class="cur">0:00</span> /
            <span class="dur">0:00</span>
          </div>
          <input class="pSeek" type="range" min="0" max="1000" value="0">
        </div>
        <audio src="/api/masters/${it.id}/stream"></audio>
      </div>

      <div class="actions">
        <button class="btn btnPrimary" onclick="window.open('/api/masters/${it.id}/download')">
          Descargar
        </button>
      </div>
    `;
    list.appendChild(div);
    bindPlayer(div);
  });
}

loadPlan();
load();
</script>

</body>
</html>
