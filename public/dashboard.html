<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WarMaster | Dashboard</title>

<style>
:root{
  --bg:#0b0c10;
  --panel: rgba(18,20,27,.92);
  --line:#232736;
  --text:#e9ecf3;
  --muted:#a8b0c3;

  /* corporativo */
  --brand:#6d5efc;
  --brand2:#2dd4bf;

  /* planes */
  --free:#ffffff;
  --plus:#f5c542;
  --pro:#4ea8ff;

  --shadow: 0 10px 30px rgba(0,0,0,.45);
  --radius: 18px;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(1200px 600px at 15% 0%, rgba(109,94,252,.25), transparent 55%),
    radial-gradient(900px 600px at 90% 10%, rgba(45,212,191,.18), transparent 55%),
    linear-gradient(180deg, var(--bg), #06070a 70%);
  color:var(--text);
  min-height:100vh;
  padding:18px;
}
.wrap{width:min(1180px,100%); margin:0 auto}

.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.space{height:12px}

.top{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin-bottom:14px;
}
.brand{
  display:flex; align-items:center; gap:10px;
  font-weight:900; letter-spacing:.3px;
}
.dot{
  width:12px;height:12px;border-radius:999px;
  background: linear-gradient(135deg, var(--brand), var(--brand2));
  box-shadow: 0 0 0 6px rgba(109,94,252,.12);
}
.nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

.pill{
  font-size:12px;
  padding:8px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  background: rgba(255,255,255,.03);
  color:var(--muted);
  white-space:nowrap;
}
.planPill{font-weight:900}
.planPill.free{ color: var(--free); border-color: rgba(255,255,255,.20); }
.planPill.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
.planPill.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }

.btn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color:var(--text);
  padding:10px 12px;
  border-radius: 12px;
  cursor:pointer;
  font-weight:900;
  transition: transform .06s ease, background .15s ease, border-color .15s ease, filter .15s ease;
  display:inline-flex; align-items:center; gap:8px;
  user-select:none;
}
.btn:hover{background: rgba(255,255,255,.06)}
.btn:active{transform: translateY(1px)}
.btnPrimary{
  border-color: transparent;
  background: linear-gradient(135deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
  color: #fff;
}
.btnPrimary:hover{filter:brightness(1.06)}

.input{
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color: var(--text);
  border-radius: 12px;
  padding:10px 12px;
  outline:none;
  min-width: 240px;
}
.select{
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  color: var(--text);
  border-radius: 12px;
  padding:10px 12px;
  outline:none;
}

.card{
  background: var(--panel);
  border:1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.head{
  padding:16px 18px;
  border-bottom:1px solid var(--line);
  background: rgba(255,255,255,.02);
  display:flex; align-items:center; justify-content:space-between; gap:12px;
}
.head h2{margin:0; font-size:16px}
.body{padding:16px 18px}

.stats{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:12px;
}
@media (max-width: 980px){ .stats{grid-template-columns: repeat(2, 1fr);} }
@media (max-width: 520px){ .stats{grid-template-columns: 1fr;} }

.stat{
  border:1px solid rgba(255,255,255,.06);
  border-radius: 16px;
  padding:14px;
  background: rgba(255,255,255,.02);
}
.stat .k{color: var(--muted); font-size:12px}
.stat .v{margin-top:6px; font-weight:900; font-size:18px}

/* LIST: 2 columnas en desktop */
.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
@media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }

/* Item card */
.item{
  border:1px solid rgba(255,255,255,.06);
  border-radius: 18px;
  padding:14px;
  background: rgba(255,255,255,.02);
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.item:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.03);
  border-color: rgba(255,255,255,.10);
}
.itemTop{
  display:flex; justify-content:space-between; align-items:flex-start;
  gap:12px; flex-wrap:wrap;
}
.title{
  font-weight:900;
  max-width: 520px;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.meta{
  margin-top:6px;
  color: var(--muted);
  font-size:12px;
  line-height:1.45;
}
.badges{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

.badge{
  font-weight:900;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.03);
  white-space:nowrap;
}
.badge.plus{ color: var(--plus); border-color: rgba(245,197,66,.35); background: rgba(245,197,66,.08); }
.badge.pro{  color: var(--pro);  border-color: rgba(78,168,255,.35); background: rgba(78,168,255,.08); }

.item.plus{
  box-shadow: 0 10px 30px rgba(0,0,0,.30), 0 0 0 1px rgba(245,197,66,.10), 0 0 22px rgba(245,197,66,.06);
}
.item.pro{
  box-shadow: 0 10px 30px rgba(0,0,0,.30), 0 0 0 1px rgba(78,168,255,.10), 0 0 22px rgba(78,168,255,.06);
}

/* Mini waveform corporativo (NO por plan todavía) */
.wave{
  height:30px;
  display:flex;
  align-items:flex-end;
  gap:4px;
  padding:8px 10px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  border-radius: 14px;
  margin-top:12px;
  overflow:hidden;
}
.wave .bar{
  width:5px;
  height:8px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(109,94,252,.95), rgba(45,212,191,.55));
  opacity:.65;
  transform-origin: bottom;
}
.item.playing .wave .bar{
  opacity: 1;
  animation: bounce 0.62s infinite ease-in-out;
}
.item.playing .wave .bar:nth-child(2){animation-delay:.05s}
.item.playing .wave .bar:nth-child(3){animation-delay:.10s}
.item.playing .wave .bar:nth-child(4){animation-delay:.15s}
.item.playing .wave .bar:nth-child(5){animation-delay:.20s}
.item.playing .wave .bar:nth-child(6){animation-delay:.25s}
.item.playing .wave .bar:nth-child(7){animation-delay:.30s}
.item.playing .wave .bar:nth-child(8){animation-delay:.35s}
.item.playing .wave .bar:nth-child(9){animation-delay:.40s}
.item.playing .wave .bar:nth-child(10){animation-delay:.45s}
.item.playing .wave .bar:nth-child(11){animation-delay:.50s}
.item.playing .wave .bar:nth-child(12){animation-delay:.55s}
@keyframes bounce{
  0%{ transform: scaleY(.35); }
  50%{ transform: scaleY(1.6); }
  100%{ transform: scaleY(.45); }
}

/* Player */
.player{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.03);
  border-radius: 14px;
  margin-top:12px;
}
.pBtn{
  width:40px;height:40px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.15);
  color: var(--text);
  font-weight:900;
  cursor:pointer;
}
.pBtn:hover{background: rgba(255,255,255,.05)}
.pMid{flex:1; min-width:0}
.pTimeRow{
  display:flex;
  gap:8px;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}
.pSeek{
  width:100%;
  accent-color: var(--brand);
  height:18px;
}
.pVol{
  width:90px;
  accent-color: var(--brand2);
  height:18px;
}
@media (max-width:520px){ .pVol{display:none} }
.player audio{display:none}

.actions{
  display:flex; gap:10px; flex-wrap:wrap;
  margin-top:12px; align-items:center;
}

.smallNote{
  margin-top:10px;
  color: var(--muted);
  font-size:12px;
  line-height:1.55;
}
.empty{
  padding:18px;
  border:1px dashed rgba(255,255,255,.15);
  border-radius: 16px;
  color: var(--muted);
  background: rgba(255,255,255,.02);
}

/* Skeleton */
.skel{
  border:1px solid rgba(255,255,255,.06);
  border-radius: 18px;
  padding:14px;
  background: rgba(255,255,255,.02);
}
.sline{
  height:12px;
  border-radius: 999px;
  background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.10), rgba(255,255,255,.04));
  background-size: 200% 100%;
  animation: shimmer 1.1s infinite linear;
}
@keyframes shimmer{
  0%{background-position: 0% 0%}
  100%{background-position: 200% 0%}
}
.sline.t{height:14px; width:60%}
.sline.m{height:12px; width:80%; margin-top:10px}
.sline.b{height:12px; width:70%; margin-top:10px}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand"><span class="dot"></span> WarMaster</div>
    <div class="nav">
      <span class="pill" id="apiPill">API: auto</span>
      <span class="pill planPill free" id="planPill">FREE</span>
      <button class="btn" id="goHome">Inicio</button>
      <button class="btn btnPrimary" id="goMaster">Nuevo Master</button>
    </div>
  </div>

  <div class="card">
    <div class="head">
      <h2>Dashboard</h2>
      <span class="pill" id="countPill">0</span>
    </div>
    <div class="body">

      <div class="stats">
        <div class="stat"><div class="k">Masters desbloqueados</div><div class="v" id="stTotal">0</div></div>
        <div class="stat"><div class="k">PLUS</div><div class="v" id="stPlus">0</div></div>
        <div class="stat"><div class="k">PRO</div><div class="v" id="stPro">0</div></div>
        <div class="stat"><div class="k">Último</div><div class="v" id="stLast">—</div></div>
      </div>

      <div class="space"></div>

      <div class="row">
        <input class="input" id="q" placeholder="Buscar por nombre o ID" autocomplete="off"/>
        <select class="select" id="filterQ">
          <option value="ALL">Todos</option>
          <option value="PLUS">PLUS</option>
          <option value="PRO">PRO</option>
        </select>
        <select class="select" id="sortQ">
          <option value="NEW">Más recientes</option>
          <option value="OLD">Más antiguos</option>
          <option value="NAME">Nombre</option>
        </select>
        <button class="btn" id="btnRefresh">Actualizar</button>
      </div>

      <div class="space"></div>

      <div id="list" class="grid"></div>
      <div id="empty" class="empty" style="display:none">
        Aún no tienes masters desbloqueados. Ve a “Nuevo Master” y usa “Desbloquear”.
      </div>

      <div class="smallNote">
        Puedes re-descargar el mismo master cuando quieras. Si subes nuevamente el audio y haces un master nuevo, se considera un nuevo producto.
      </div>

    </div>
  </div>
</div>

<script>
  function getApiBase() {
    const qs = new URLSearchParams(location.search);
    const fromQS = qs.get("api");
    if (fromQS) return fromQS.replace(/\/+$/,'');
    const stored = localStorage.getItem("WM_API_BASE");
    if (stored) return stored.replace(/\/+$/,'');
    return "";
  }
  const API_BASE = getApiBase();
  document.getElementById("apiPill").textContent = "API: " + (API_BASE || "mismo dominio");

  function qsCarry(path){
    const qs = new URLSearchParams(location.search);
    const api = qs.get("api");
    return api ? (path + "?api=" + encodeURIComponent(api)) : path;
  }
  document.getElementById("goHome").onclick = () => location.href = qsCarry("/index.html");
  document.getElementById("goMaster").onclick = () => location.href = qsCarry("/master.html");

  async function fetchWithTimeout(url, options={}, timeoutMs=180000) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), timeoutMs);
    try { return await fetch(url, { ...options, signal: ctrl.signal }); }
    finally { clearTimeout(id); }
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // PLAN
  let currentPlan = "FREE";
  function applyPlanUI(){
    const pill = document.getElementById("planPill");
    pill.classList.remove("free","plus","pro");
    if(currentPlan === "PLUS"){ pill.classList.add("plus"); pill.textContent = "PLUS"; }
    else if(currentPlan === "PRO"){ pill.classList.add("pro"); pill.textContent = "PRO"; }
    else { pill.classList.add("free"); pill.textContent = "FREE"; }
  }
  async function loadPlan(){
    try{
      const res = await fetchWithTimeout((API_BASE||"") + "/api/me", {}, 12000);
      if(!res.ok) throw new Error("no /api/me");
      const data = await res.json();
      currentPlan = (data.plan || "FREE").toUpperCase();
      if(!["FREE","PLUS","PRO"].includes(currentPlan)) currentPlan="FREE";
    }catch(e){
      currentPlan = "FREE";
    }
    applyPlanUI();
  }

  // Player
  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec || 0));
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function bindPlayer(card){
    const audio = card.querySelector("audio");
    const btn = card.querySelector('[data-act="play"]');
    const seek = card.querySelector('[data-act="seek"]');
    const vol  = card.querySelector('[data-act="vol"]');
    const cur  = card.querySelector('[data-k="cur"]');
    const dur  = card.querySelector('[data-k="dur"]');

    let dragging = false;

    function syncBtn(){ btn.textContent = audio.paused ? "Play" : "Pause"; }

    audio.addEventListener("loadedmetadata", () => {
      dur.textContent = fmtTime(audio.duration);
      cur.textContent = "0:00";
      seek.value = "0";
    });

    audio.addEventListener("timeupdate", () => {
      if(dragging) return;
      cur.textContent = fmtTime(audio.currentTime);
      const p = audio.duration ? (audio.currentTime / audio.duration) : 0;
      seek.value = String(Math.round(p * 1000));
    });

    audio.addEventListener("play", () => { card.classList.add("playing"); syncBtn(); });
    audio.addEventListener("pause", () => { card.classList.remove("playing"); syncBtn(); });
    audio.addEventListener("ended", () => { audio.currentTime = 0; audio.pause(); });

    btn.addEventListener("click", () => {
      document.querySelectorAll("audio").forEach(a => { if(a !== audio) a.pause(); });
      if(audio.paused) audio.play(); else audio.pause();
    });

    seek.addEventListener("input", () => { dragging = true; });
    seek.addEventListener("change", () => {
      dragging = false;
      const p = Number(seek.value) / 1000;
      if(audio.duration) audio.currentTime = p * audio.duration;
    });

    vol.addEventListener("input", () => { audio.volume = Number(vol.value); });
    audio.volume = Number(vol.value);
    syncBtn();
  }

  // Skeleton
  function showSkeleton(){
    const list = document.getElementById("list");
    list.innerHTML = "";
    for(let i=0;i<6;i++){
      const d = document.createElement("div");
      d.className = "skel";
      d.innerHTML = `
        <div class="sline t"></div>
        <div class="sline m"></div>
        <div class="sline b"></div>
      `;
      list.appendChild(d);
    }
  }

  // Stats
  function setStats(items){
    document.getElementById("stTotal").textContent = String(items.length);
    document.getElementById("stPlus").textContent  = String(items.filter(x => (x.quality||"").toUpperCase()==="PLUS").length);
    document.getElementById("stPro").textContent   = String(items.filter(x => (x.quality||"").toUpperCase()==="PRO").length);

    const last = items[0]?.created_at || "—";
    document.getElementById("stLast").textContent = last==="—" ? "—" : last.slice(0,19).replace("T"," ");
  }

  function badgeHTML(q){
    q = (q||"PLUS").toUpperCase();
    if(q === "PRO") return `<span class="badge pro">PRO</span>`;
    return `<span class="badge plus">PLUS</span>`;
  }

  function waveHTML(){
    let s = `<div class="wave" aria-label="waveform">`;
    for(let i=0;i<12;i++){
      const h = 8 + ((i*7) % 16);
      s += `<span class="bar" style="height:${h}px"></span>`;
    }
    s += `</div>`;
    return s;
  }

  // Data + filtros
  let allItems = [];

  function applyFilters(){
    const q = (document.getElementById("q").value || "").toLowerCase().trim();
    const f = document.getElementById("filterQ").value;
    const s = document.getElementById("sortQ").value;

    let items = [...allItems];

    if(f !== "ALL"){
      items = items.filter(x => (x.quality||"").toUpperCase() === f);
    }

    if(q){
      items = items.filter(x => {
        const t = (x.title || "").toLowerCase();
        const id = (x.id || "").toLowerCase();
        return t.includes(q) || id.includes(q);
      });
    }

    if(s === "OLD"){
      items.sort((a,b)=> String(a.created_at||"").localeCompare(String(b.created_at||"")));
    } else if(s === "NAME"){
      items.sort((a,b)=> String(a.title||"").localeCompare(String(b.title||"")));
    } else {
      items.sort((a,b)=> String(b.created_at||"").localeCompare(String(a.created_at||"")));
    }

    render(items);
  }

  function render(items){
    const list = document.getElementById("list");
    const empty = document.getElementById("empty");
    list.innerHTML = "";

    document.getElementById("countPill").textContent = String(items.length);
    setStats(items);

    if(!items.length){
      empty.style.display = "";
      return;
    }
    empty.style.display = "none";

    items.forEach(it => {
      const q = (it.quality||"PLUS").toUpperCase();
      const card = document.createElement("div");
      card.className = "item " + (q === "PRO" ? "pro" : "plus");

      const title = escapeHtml(it.title || ("Master " + it.id));
      const created = escapeHtml((it.created_at || "").slice(0,19).replace("T"," "));
      const preset = escapeHtml(it.preset || "clean");
      const intensity = escapeHtml(String(it.intensity ?? 55));
      const id = escapeHtml(it.id);

      card.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="title">${title}</div>
            <div class="meta">${created || "—"} · Preset: ${preset} · Intensidad: ${intensity} · ID: ${id}</div>
          </div>
          <div class="badges">${badgeHTML(q)}</div>
        </div>

        ${waveHTML()}

        <div class="player">
          <button class="pBtn" data-act="play" type="button">Play</button>
          <div class="pMid">
            <div class="pTimeRow">
              <span data-k="cur">0:00</span>
              <span>/</span>
              <span data-k="dur">0:00</span>
            </div>
            <input class="pSeek" type="range" min="0" max="1000" value="0" data-act="seek"/>
          </div>
          <input class="pVol" type="range" min="0" max="1" step="0.01" value="1" data-act="vol" aria-label="vol"/>
          <audio preload="metadata"></audio>
        </div>

        <div class="actions">
          <button class="btn btnPrimary" type="button" data-act="download">Descargar</button>
          <button class="btn" type="button" data-act="open">Abrir</button>
          <button class="btn" type="button" data-act="copy">Copiar ID</button>
        </div>
      `;

      const audio = card.querySelector("audio");
      audio.src = (API_BASE||"") + `/api/masters/${encodeURIComponent(it.id)}/stream`;

      card.querySelector('[data-act="download"]').onclick = () => {
        const url = (API_BASE||"") + `/api/masters/${encodeURIComponent(it.id)}/download`;
        window.open(url, "_blank");
      };

      card.querySelector('[data-act="open"]').onclick = () => {
        const url = (API_BASE||"") + `/api/masters/${encodeURIComponent(it.id)}/stream`;
        window.open(url, "_blank");
      };

      card.querySelector('[data-act="copy"]').onclick = async () => {
        try{
          await navigator.clipboard.writeText(it.id);
          const b = card.querySelector('[data-act="copy"]');
          b.textContent = "Copiado";
          setTimeout(()=> b.textContent = "Copiar ID", 900);
        }catch(e){
          alert("No se pudo copiar.");
        }
      };

      bindPlayer(card);
      list.appendChild(card);
    });
  }

  async function loadMasters(){
    showSkeleton();
    const res = await fetchWithTimeout((API_BASE||"") + "/api/masters", {}, 180000);
    if(!res.ok){
      allItems = [];
      render([]);
      return;
    }
    const data = await res.json();
    allItems = Array.isArray(data) ? data : [];
    applyFilters();
  }

  document.getElementById("btnRefresh").onclick = loadMasters;
  document.getElementById("q").addEventListener("input", applyFilters);
  document.getElementById("filterQ").addEventListener("change", applyFilters);
  document.getElementById("sortQ").addEventListener("change", applyFilters);

  (async function init(){
    await loadPlan();
    await loadMasters();
  })();
</script>
</body>
</html>
